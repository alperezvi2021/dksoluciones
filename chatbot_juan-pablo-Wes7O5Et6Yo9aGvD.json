{"createdAt":"2025-07-21T23:39:36.304Z","updatedAt":"2025-09-02T10:11:24.000Z","id":"Wes7O5Et6Yo9aGvD","name":"Chatbot_Juan pablo","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"b8782175-900b-4c10-8989-1cbe52198bdd","options":{}},"name":"Webhook -- Wasapi","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-2848,-160],"id":"041693c6-fb0d-40db-9f1a-8c6172f4885b","webhookId":"b8782175-900b-4c10-8989-1cbe52198bdd"},{"parameters":{"resource":"audio","operation":"transcribe","options":{"language":"es"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-1568,-336],"id":"fe86be62-4dbf-48da-8684-d03e088e01a8","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"334eb726-7674-4f91-beb1-16da6d8d0eb3","leftValue":"={{ $json.type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.type }}","rightValue":"text","operator":{"type":"string","operation":"equals"},"id":"b055bc2e-a7e7-402f-a616-6c42b02dd4a1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0a13d3d0-4bf9-4dff-9057-eebf9f04c4b4","leftValue":"{{ $json.type }}","rightValue":"","operator":{"type":"object","operation":"exists","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"imagen"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2000,-176],"id":"1d021593-ec42-48c6-8b46-5a362baaabc4","name":"Tipo de Mensaje"},{"parameters":{"assignments":{"assignments":[{"id":"3b47ea5a-a76c-4160-a88d-d685658c200d","name":"body","value":"={{ $json.body }}","type":"string"},{"id":"d550409f-9300-49ab-b18b-63ce3629a4bc","name":"type","value":"={{ $json.body.data.message_type }}","type":"string"},{"id":"27d2c7af-747b-4849-925b-08246cb276db","name":"message","value":"={{ $json.body.data.message }}","type":"string"},{"id":"61b336dd-b2b2-4332-904e-1a8b68157a24","name":"number","value":"={{ $json.body.data.wa_id }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2288,-176],"id":"60197570-7798-4733-bdf5-fe795ecfb65b","name":"Mapea el Mensaje Usuario"},{"parameters":{"values":{"string":[{"name":"number","value":"={{ $('Mapea el Mensaje Usuario').item.json.number }}  "},{"name":"mensaje_usuario","value":"={{ $json.message }}{{ $json.text }}"}]},"options":{}},"name":"Recibe Mensaje","type":"n8n-nodes-base.set","typeVersion":2,"position":[-1328,-176],"id":"41a58c5a-0a13-436a-8e11-ae606ca8f508"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-928,64],"id":"b5a69c1b-2062-4fe0-94fd-26b1902abdf0","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"GPT-4.1-MINI"},"messages":{"values":[{"content":"={{ $json.output }}"},{"content":"En base a la respuesta recibida, determina si la respuesta deberíamos dársela en formato audio o formato texto.\n\nTrata de enviar el 0% de las veces un audio y 100% texto. resérvate el texto para cuando te pida en el mensaje explícitamente que le envíes un texto y para cuando en el mensaje se detalle mucha información sobre el programa, los módulos, etc... y supere la capacidad de tamaño permitida por la plataforma que es de 2MB\n\nSimplemente responde: \"Audio\" o \"Texto\"","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-16,192],"id":"d58813fe-6db4-4784-a24d-7d80c94f8491","name":"Tipo de Respuesta","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.message.content }}","rightValue":"Texto","operator":{"type":"string","operation":"equals"},"id":"0f070bd9-c076-4298-bfd4-8f81f87a4494"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c5f99960-651b-443a-87ff-54d6232af484","leftValue":"={{ $json.message.content }}","rightValue":"Audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[400,192],"id":"2c530655-7288-4163-ab90-2bf98c7010af","name":"Selecciona Respuesta"},{"parameters":{"url":"={{$json[\"message\"]}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1760,-336],"id":"62cb5f63-0177-4cb3-8ec3-68ebf8883be1","name":"Captura Audio","alwaysOutputData":false},{"parameters":{"operation":"write","fileName":"=/files/audios/audio.mp3","options":{}},"type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[1024,208],"id":"70de782a-bd3d-4752-90aa-dc8f2692ad6c","name":"Descargar Audio"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[704,-224],"id":"1ea63a59-0fcc-4d0b-b6c5-adaba57610de","name":"Espera para enviar Mensaje","webhookId":"4ab86d71-d982-4ad4-a6b9-01a240f0ad49"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/attachment","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"file","value":"audio_url"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"audio_url","value":"={{ $json.stdout }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1520,208],"id":"b8d2f319-fa48-4791-a886-7c934ee21cf5","name":"Envia Mensajes Audio"},{"parameters":{"method":"POST","url":" https://api-ws.wasapi.io/api/v1/whatsapp-messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Agente Juan Pablo').item.json.output }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[784,-16],"id":"4ea49097-642d-481d-954a-b3e0f92160a0","name":"Envia Mensaje Texto"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c6f97ebd-22b9-43a2-8611-23883d460893","leftValue":"={{ $json.data.message }}","rightValue":"Ya mismo agendaremos la visita","operator":{"type":"string","operation":"contains"}},{"id":"84170832-f7fb-4550-a157-3813fb90be79","leftValue":"={{ $json.data.message }}","rightValue":"=ya está confirmada","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1024,-16],"id":"cce9ea87-8980-485a-a29b-f439e717aa70","name":"Verifica si estan los Datos"},{"parameters":{"jsCode":"// Obtener el número desde el nodo \"Mapea el Mensaje Usuario\"\nlet numeroOriginal = $('Mapea el Mensaje Usuario').first().json.number || '';\n\n// Convertir a string si no lo es\nif (typeof numeroOriginal !== 'string') {\nnumeroOriginal = String(numeroOriginal);\n}\n\n// Limpiar el número de caracteres no numéricos\nconst numero = numeroOriginal.replace(/\\D/g, '');\n\n// Lista de contactos recibida desde el nodo \"Get many contacts\"\nconst contactos = items;\n\nlet existe = false;\n\nfor (const contacto of contactos) {\nconst telefonos = contacto.json.phoneNumbers?.mobile || [];\nfor (const tel of telefonos) {\nconst telLimpio = String(tel).replace(/\\D/g, '');\nif (telLimpio === numero) {\nexiste = true;\nbreak;\n}\n}\nif (existe) break;\n}\n// Devolver resultado para el nodo IF\nreturn [{ json: { existe } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2144,-48],"id":"56263a31-2a0e-4502-a42e-e083131df05e","name":"Resultado de la Busquedad"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"01bb1256-606c-4108-ab62-19d62cb2086c","leftValue":"={{ $json.existe }}","rightValue":"false","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2368,-48],"id":"bf8876a6-f698-47d7-9556-b146a1534de6","name":"Verifica si el Contacto Existe"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/change-status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"status","value":"open"},{"name":"validate_assigned_status","value":"1"},{"name":"agent_id","value":"=35950"},{"name":"assignToAgentId","value":"35950"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1728,-48],"id":"5e76994f-0e3e-4f97-9bab-18d4809d74a5","name":"Cambia Estado Conversacion"},{"parameters":{"command":"sh /files/audios/renombrar_audio.sh"},"type":"n8n-nodes-base.executeCommand","typeVersion":1,"position":[1280,208],"id":"a9ea51fb-5b1d-4ca5-b7f4-43db3bd367c6","name":"Renombra Archivo Audio"},{"parameters":{"operation":"getAll","returnAll":true,"fields":["phoneNumbers","names","emailAddresses"],"options":{}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[1952,-48],"id":"8e3121bd-e7eb-4769-ae89-c4c57f200458","name":"Busca el Contacto","credentials":{"googleContactsOAuth2Api":{"id":"TkGa2FKaBkS7I3Ja","name":"Contacts account Juan Pablo"}}},{"parameters":{"jsCode":"// Obtener datos desde el nodo \"Extrae los Datos del Cliente\"\nconst nombre = $node[\"Extrae los Datos del Cliente\"].json.nombre;\nconst celular = $node[\"Extrae los Datos del Cliente\"].json.celular;\nconst correo = $node[\"Extrae los Datos del Cliente\"].json.correo;\nconst proyecto = $node[\"Extrae los Datos del Cliente\"].json.proyecto;\n\nreturn [\n  {\n    json: {\n      nombre,\n      celular,\n      correo,\n      proyecto\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2624,-64],"id":"8519a49e-3e1f-4fd0-a60d-8791b714d76b","name":"Datos Contacto"},{"parameters":{"familyName":"=","givenName":"={{ $json.nombre }}","additionalFields":{"emailsUi":{"emailsValues":[{"type":"work","value":"={{ $json.correo }}"}]},"phoneUi":{"phoneValues":[{"type":"mobile","value":"=+{{ $json.celular }}"}]}}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[2848,-64],"id":"d656e099-e832-42dc-83c3-b7ee96203f58","name":"Crear un Contacto","credentials":{"googleContactsOAuth2Api":{"id":"TkGa2FKaBkS7I3Ja","name":"Contacts account Juan Pablo"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"75cc19e7-a633-4a11-8899-df43c9399c26","leftValue":"={{ $json.body.data.chat_status.conversation_status }}","rightValue":"open","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2560,-160],"id":"d2362abf-448c-4ab6-8f35-50dcea8371a3","name":"Comprueba Estado de la Conversación"},{"parameters":{"jsCode":"const texto = $json.output || \"\";\nconst marcadoresDisponibles = [\n  \"ENVIAR_IMAGENES_BOREAL\",\n  \"ENVIAR_VIDEO_BOREAL\",\n  \"ENVIAR_IMAGENES_NATTIVO\",\n  \"ENVIAR_VIDEO_NATTIVO\"\n];\n\nconst marcadoresDetectados = marcadoresDisponibles.filter(m =>\n  texto.includes(`[[${m}]]`)\n);\n\nif (marcadoresDetectados.length === 0) {\n  return [\n    {\n      json: {\n        resultado: \"NO_MARKERS_FOUND\",\n        original: texto\n      }\n    }\n  ];\n}\n\nreturn [\n  {\n    json: {\n      marcadores: marcadoresDetectados\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-80,-336],"id":"5477d1b7-b78e-4bbb-ba9b-ec9ccdb38a83","name":"Detectar Marcadores"},{"parameters":{"jsCode":"const marcadores = $json.marcadores || [];\n\nconst driveUrls = {\n  ENVIAR_IMAGENES_BOREAL: [\n    \"https://drive.google.com/uc?id=1pfzeYiKLiodbotqQci5ZGUPcZeTk72jE\",\n    \"https://drive.google.com/uc?id=1TgSosy157Kg0_GfsniQzwdargLjYn9Hg\",\n    \"https://drive.google.com/uc?id=1DQ6ZFjPfNGNnF4PMDGTirAb1wDN8WC_0\",\n    \"https://drive.google.com/uc?id=1loho1vB8GuDWYwTHyUDTQE37ZMVyaZA5\",\n    \"https://drive.google.com/uc?id=1IrmC4fnfKeP1eQa1FWYkwIhjKhV80Sb4\",\n    \"https://drive.google.com/uc?id=1MYIebTyAUGS_O0UoFDkCZZWsJdjJwF_2\",\n    \"https://drive.google.com/uc?id=1dFplyLlvd0cZHw-gsueUYWNc_VlnPBpf\",\n    \"https://drive.google.com/uc?id=16V88zZCc6Zfid3_gi9dW_DDF25mM53zw\"\n  ],\n  ENVIAR_VIDEO_BOREAL: [\n    \"https://drive.google.com/uc?id=1G2B4Zfft0ZRNBogvRJzpmZLKYTXoElbT\",\n    \"https://drive.google.com/uc?id=1ZbTheV1qbfYAezxpGO2M6zeta9BCstXk\"\n  ],\n  ENVIAR_IMAGENES_NATTIVO: [\n    \"https://drive.google.com/uc?id=12HlGHSkFpfpep1aI_wJYlBfNPx6Pi0iK\",\n    \"https://drive.google.com/uc?id=1Jspnwf7z9jzLPIIZiMJsXG4ofcy-r3d-\",\n    \"https://drive.google.com/uc?id=1sizL9DrP9SY-OFX7zCiofwr-iTUmmreN\",\n    \"https://drive.google.com/uc?id=1C4ISYT7lGX8ZngPeNOR34W1jDZy6pNCI\",\n    \"https://drive.google.com/uc?id=1F1hMSdQhm0BA0tzH2nWYDkwO81SEMhKY\",\n    \"https://drive.google.com/uc?id=1qtUZeYFqqW0yHH94AIUyS5yuiHHVr73v\",\n    \"https://drive.google.com/uc?id=1s_GKNjuWXBn_KP3l7_Jr2iFMHoNnbF_K\",\n    \"https://drive.google.com/uc?id=1Hb22rawrHeS0IPJw6OBPfA1VwntQHrfQ\"\n  ],\n  ENVIAR_VIDEO_NATTIVO: [\n    \"https://drive.google.com/uc?id=1X-OsB5Acf0FQDem61_DNxaj1uDw4N_-c\"\n  ]\n};\n\nconst resultados = [];\n\nfor (const marcador of marcadores) {\n  const tipo = marcador.includes(\"VIDEO\") ? \"video\" : \"image\";\n  const urls = driveUrls[marcador] || [];\n\n  for (const url of urls) {\n    resultados.push({\n      json: {\n        tipo,\n        media_url: url\n      }\n    });\n  }\n}\n\nif (resultados.length === 0) {\n  return [{ json: { error: \"NO_FILES_FOUND\" } }];\n}\n\nreturn resultados;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[192,-336],"id":"fa9015bf-433b-41bc-b347-29f4fe9de42c","name":"Generar Lista Multimedia"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/attachment","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"file","value":"video_url"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"video_url","value":"={{ $json.media_url }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[928,-448],"id":"bc657e5a-1268-429c-b03f-4f7c637c6736","name":"Enviar Mensaje Videos","executeOnce":false},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/attachment","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"file","value":"image_url"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"image_url","value":"={{ $json.media_url }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,-656],"id":"d1be0130-7027-4d14-b919-33ac8164a560","name":"Enviar Mensaje Imagenes","executeOnce":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"1bfdf3bd-4020-4e50-aa4e-73cf4e00490d","leftValue":"={{ $json.output }}","rightValue":"[[ENVIAR_IMAGENES_NATTIVO]]","operator":{"type":"string","operation":"contains"}},{"id":"4eb7a703-e33c-4f1d-a2b5-29d152bed72d","leftValue":"={{ $json.output }}","rightValue":"[[ENVIAR_VIDEO_NATTIVO]]","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"83c42724-da56-498a-9b4e-c9bf0ff0a1b8","leftValue":"={{ $json.output }}","rightValue":"[[ENVIAR_IMAGENES_BOREAL]]","operator":{"type":"string","operation":"contains"}},{"id":"d39d99fa-97c2-48f2-9f8c-4cd5b82ef0e4","leftValue":"={{ $json.output }}","rightValue":"[[ENVIAR_VIDEO_BOREAL]]","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"name":"Es Marcador?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-368,-176],"id":"d3b48f50-a8a7-4b74-bc7c-5408410e3656"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"62b4890c-6608-467c-9be8-0a183724a06e","leftValue":"={{ $json.tipo }}","rightValue":"image","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[400,-528],"id":"bb083598-41e6-4668-badb-436a4d1935af","name":"Es Imagen?","alwaysOutputData":false},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[672,-448],"id":"cd7a6c9f-9e15-4950-a25b-b9b2fac13c16","name":"Espera para enviar video","webhookId":"922f891d-80f3-4759-a3b9-dd9679215855"},{"parameters":{"jsCode":"// Tomar el mensaje del Agente Luisa\nconst mensajeDelAgente = $node[\"Agente Juan Pablo\"].json.output || \"\";\n\n// Eliminar marcadores del tipo [[...]]\nconst mensajeLimpio = mensajeDelAgente.replace(/\\[\\[.*?\\]\\]/g, '').replace(/\\s{2,}/g, ' ').trim();\n\n// Tomar datos del Webhook\nconst wa_id = $('Webhook -- Wasapi').first().json.body.data.wa_id;\nconst from_id = $('Webhook -- Wasapi').first().json.body.data.from_id;\n\nreturn [\n  {\n    json: {\n      mensaje_final: mensajeLimpio,\n      wa_id,\n      from_id\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[400,-224],"id":"99ca3b71-2c5c-49d6-98c8-896585efaab7","name":"Preparar para Texto Final"},{"parameters":{"method":"POST","url":" https://api-ws.wasapi.io/api/v1/whatsapp-messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"message","value":"={{ $json.mensaje_final }}"},{"name":"wa_id","value":"={{ $json.wa_id }}"},{"name":"from_id","value":"={{ $json.from_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[960,-224],"id":"df29fde0-f31d-4b4d-ae7d-b606cd24bd1e","name":"Enviar Mensaje"},{"parameters":{"jsCode":"const mensaje = $json.data.message.toLowerCase();\n\n// Ajuste de fecha actual en zona horaria UTC−5 (Colombia)\nconst ahora = new Date();\nconst offsetColombia = -5; // UTC−5\nconst hoy = new Date(ahora.getTime() + offsetColombia * 60 * 60 * 1000);\n\n// Función para convertir día de la semana en número\nfunction diaSemanaANum(dia) {\n\tconst dias = {\n\t\tdomingo: 0,\n\t\tlunes: 1,\n\t\tmartes: 2,\n\t\tmiércoles: 3,\n\t\tmiercoles: 3,\n\t\tjueves: 4,\n\t\tviernes: 5,\n\t\tsábado: 6,\n\t\tsabado: 6,\n\t};\n\treturn dias[dia.toLowerCase()] ?? -1;\n}\n\n// Formatea una fecha como dd/mm/yyyy\nfunction formatearFecha(date) {\n\treturn `${String(date.getDate()).padStart(2, '0')}/${\n\t\tString(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;\n}\n\n// Extrae o interpreta la fecha del mensaje\nfunction extraerFechaDesdeMensaje(texto) {\n\t// Buscar una fecha explícita tipo 17/07/2025\n\tconst matchFecha = texto.match(/(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})/);\n\tif (matchFecha) {\n\t\tconst [_, d, m, y] = matchFecha;\n\t\treturn `${String(d).padStart(2, '0')}/${String(m).padStart(2, '0')}/${y.length === 2 ? '20' + y : y}`;\n\t}\n\n\t// Expresiones relativas\n\tif (texto.includes(\"pasado mañana\")) {\n\t\tconst fecha = new Date(hoy.getTime());\n\t\tfecha.setDate(hoy.getDate() + 2);\n\t\treturn formatearFecha(fecha);\n\t}\n\tif (texto.includes(\"mañana\")) {\n\t\tconst fecha = new Date(hoy.getTime());\n\t\tfecha.setDate(hoy.getDate() + 1);\n\t\treturn formatearFecha(fecha);\n\t}\n\tif (texto.includes(\"hoy\")) {\n\t\treturn formatearFecha(hoy);\n\t}\n\n\t// Día de la semana (sábado, domingo, etc.)\n\tconst matchDia = texto.match(/\\b(lunes|martes|miércoles|miercoles|jueves|viernes|sábado|sabado|domingo)\\b/);\n\tif (matchDia) {\n\t\tconst hoyDia = hoy.getDay();\n\t\tconst diaObjetivo = diaSemanaANum(matchDia[1]);\n\t\tlet diasADesplazar = (diaObjetivo - hoyDia + 7) % 7;\n\t\tif (diasADesplazar === 0) diasADesplazar = 7;\n\t\tconst fecha = new Date(hoy.getTime());\n\t\tfecha.setDate(hoy.getDate() + diasADesplazar);\n\t\treturn formatearFecha(fecha);\n\t}\n\n\treturn '';\n}\n\n// Extrae la hora del mensaje (explícita o por contexto)\nfunction extraerHoraDesdeMensaje(texto) {\n\tconst matchHora = texto.match(/hora de cita:\\s*(\\d{1,2}:\\d{2})/i);\n\tif (matchHora) return matchHora[1];\n\n\t// Interpretación por contexto\n\tif (texto.includes(\"mañana\")) return \"09:00\";\n\tif (texto.includes(\"mediodía\") || texto.includes(\"medio dia\") || texto.includes(\"al mediodía\")) return \"12:00\";\n\tif (texto.includes(\"tarde\")) return \"15:00\";\n\tif (texto.includes(\"noche\")) return \"18:00\";\n\n\treturn '';\n}\n\n// Extrae otros campos\nconst datos = {\n\tfecha: extraerFechaDesdeMensaje(mensaje),\n\thora: extraerHoraDesdeMensaje(mensaje),\n\tnombre: mensaje.match(/nombre:\\s*(.+?)(?=\\n|$)/i)?.[1].trim() || '',\n\tcelular: mensaje.match(/celular:\\s*(.+?)(?=\\n|$)/i)?.[1].trim() || '',\n\tcorreo: mensaje.match(/correo electrónico:\\s*(.+?)(?=\\n|$)/i)?.[1].trim() || '',\n\tproyecto: mensaje.match(/proyecto de su interés:\\s*(.+?)(?=\\n|$)/i)?.[1].trim() || ''\n};\n\nreturn [{ json: datos }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,-48],"id":"f3df3a79-4c71-48a5-867c-21ea84382c23","name":"Extrae los Datos del Cliente"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1PtajXQmYWAJt_xHmEsEkayUKImU4cRLbBzsi5txMmhE","mode":"list","cachedResultName":"Datos Pedido Cliente","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1PtajXQmYWAJt_xHmEsEkayUKImU4cRLbBzsi5txMmhE/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1658038468,"mode":"list","cachedResultName":"Hoja 2","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1ZCitmztJaNVVQNEOzCMhGCKpctTKyKpL4TGlKOZ6ZWI/edit#gid=1658038468"},"columns":{"mappingMode":"defineBelow","value":{"Fecha de la visita ":"={{ $json.fecha }}","Nombre ":"={{ $json.nombre }}","Celular ":"={{ $json.celular }}","Hora de la cita":"={{ $json.hora }}","Correo electronico ":"={{ $json.correo }}","Proyecto de su intereres ":"={{ $json.proyecto }}"},"matchingColumns":[],"schema":[{"id":"Fecha de la visita ","displayName":"Fecha de la visita ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Nombre ","displayName":"Nombre ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Celular ","displayName":"Celular ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Hora de la cita","displayName":"Hora de la cita","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Correo electronico ","displayName":"Correo electronico ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Proyecto de su intereres ","displayName":"Proyecto de su intereres ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Visita concluida ","displayName":"Visita concluida ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Seguimiento del cliente","displayName":"Seguimiento del cliente","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[1504,-48],"id":"daba4c78-4754-4b41-9ee5-00c5a87dc074","name":"Guarda datos del Cliente","credentials":{"googleSheetsOAuth2Api":{"id":"cqsaobPCIYBh6vWF","name":"Google Sheets account Juan Pablo"}}},{"parameters":{"calendar":{"__rl":true,"value":"ggc.wasappi@gmail.com","mode":"list","cachedResultName":"ggc.wasappi@gmail.com"},"start":"={{ $json.start }}","end":"={{ $json.end }}","additionalFields":{"attendees":["={{ $('Datos Contacto').item.json.correo }}"],"description":"=Visita agendada para {{ $('Datos Contacto').item.json.nombre }} al proyecto {{ $('Datos Contacto').item.json.proyecto }}","summary":"=Visita agendada para {{ $('Datos Contacto').item.json.nombre }} al proyecto {{ $('Datos Contacto').item.json.proyecto }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[3328,-64],"id":"cea738f4-2959-42af-83a4-bf6cbf06d8ec","name":"Agendar Citas","credentials":{"googleCalendarOAuth2Api":{"id":"gmO9fJ17ajAbGI5c","name":"Calendario Gomez Giraldo Constructores"}}},{"parameters":{"jsCode":"// 📌 Nodo: Prepara fecha y hora\n\nconst fechaTexto = $node[\"Extrae los Datos del Cliente\"].json.fecha; // ej: \"17/07/2025\"\nconst horaTexto = $node[\"Extrae los Datos del Cliente\"].json.hora;   // ej: \"9\", \"09:00\", \"9 AM\", \"13:30\"\n\ntry {\n  if (!fechaTexto || !horaTexto) throw new Error(\"Faltan datos de fecha u hora.\");\n\n  // Validar y descomponer la fecha en formato DD/MM/YYYY\n  const [dia, mes, anio] = fechaTexto.split(\"/\").map(v => parseInt(v));\n  if (!dia || !mes || !anio) throw new Error(\"Fecha inválida. Formato esperado: DD/MM/YYYY\");\n\n  // Normalizar la hora\n  let horaLimpia = horaTexto.trim().toUpperCase();\n\n  // Agregar minutos si solo viene la hora (ej. \"9\" → \"9:00\")\n  if (/^\\d{1,2}$/.test(horaLimpia)) {\n    horaLimpia += \":00\";\n  }\n\n  // Construcción de fecha final según formato\n  let fechaHoraTexto;\n\n  if (horaLimpia.includes(\"AM\") || horaLimpia.includes(\"PM\")) {\n    // Formato con AM/PM → MM/DD/YYYY HH:MM AM/PM\n    fechaHoraTexto = `${mes}/${dia}/${anio} ${horaLimpia}`;\n  } else {\n    // Formato 24h → YYYY-MM-DDTHH:MM:00\n    fechaHoraTexto = `${anio}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}T${horaLimpia}:00`;\n  }\n\n  const startDate = new Date(fechaHoraTexto);\n  if (isNaN(startDate)) throw new Error(\"No se pudo interpretar la fecha y hora. Revisa el formato.\");\n\n  const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // +1 hora\n\n  return [{\n    json: {\n      start: startDate.toISOString(),\n      end: endDate.toISOString()\n    }\n  }];\n} catch (error) {\n  return [{\n    json: {\n      error: `Error: ${error.message}`\n    }\n  }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3072,-64],"id":"c1d6514f-375a-4d3d-b6c3-26ec01567906","name":"Prepara Hora y Fecha"},{"parameters":{"jsCode":"const mensaje = $json.mensaje_usuario.toLowerCase();\nconst hoy = new Date();\n\n// Función para formatear fecha como dd/mm/yyyy\nfunction formatearFecha(fecha) {\n  return `${String(fecha.getDate()).padStart(2, '0')}/${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;\n}\n\n// Función para convertir nombre de día a número\nfunction diaSemanaANum(dia) {\n  const dias = {\n    domingo: 0,\n    lunes: 1,\n    martes: 2,\n    miércoles: 3,\n    miercoles: 3,\n    jueves: 4,\n    viernes: 5,\n    sábado: 6,\n    sabado: 6,\n  };\n  return dias[dia.toLowerCase()] ?? -1;\n}\n\nlet fechaInterpretada = '';\n\n// Fecha explícita\nconst matchFecha = mensaje.match(/(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})/);\nif (matchFecha) {\n  const [_, d, m, y] = matchFecha;\n  fechaInterpretada = `${String(d).padStart(2, '0')}/${String(m).padStart(2, '0')}/${y.length === 2 ? '20' + y : y}`;\n}\n\n// Palabras clave\nelse if (mensaje.includes(\"pasado mañana\")) {\n  const fecha = new Date(hoy);\n  fecha.setDate(hoy.getDate() + 2);\n  fechaInterpretada = formatearFecha(fecha);\n}\nelse if (mensaje.includes(\"mañana\")) {\n  const fecha = new Date(hoy);\n  fecha.setDate(hoy.getDate() + 1);\n  fechaInterpretada = formatearFecha(fecha);\n}\nelse {\n  const matchDia = mensaje.match(/\\b(lunes|martes|miércoles|miercoles|jueves|viernes|sábado|sabado|domingo)\\b/);\n  if (matchDia) {\n    const diaObjetivo = diaSemanaANum(matchDia[1]);\n    const diaHoy = hoy.getDay();\n    let diasADesplazar = (diaObjetivo - diaHoy + 7) % 7;\n    if (diasADesplazar === 0) diasADesplazar = 7;\n    const fecha = new Date(hoy);\n    fecha.setDate(hoy.getDate() + diasADesplazar);\n    fechaInterpretada = formatearFecha(fecha);\n  }\n}\n\nreturn [{\n  json: {\n    ...$json,\n    fecha_interpretada: fechaInterpretada\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1040,-176],"id":"2d1266ec-2700-4d09-b7e1-94fc55f5bd93","name":"Interpreta Fecha"},{"parameters":{"resource":"speech","voice":{"__rl":true,"value":"MI20Sd1mLWrbCtKlgO2y","mode":"list","cachedResultName":"Simón"},"text":"={{ $('Agente Juan Pablo').item.json.output }}","additionalOptions":{},"requestOptions":{}},"type":"@elevenlabs/n8n-nodes-elevenlabs.elevenLabs","typeVersion":1,"position":[768,208],"id":"1e8c14ae-e2a7-4ba7-a317-559f04f124ce","name":"Convert text to speech","credentials":{"elevenLabsApi":{"id":"itAUe2vHxXrVFlMg","name":"Voz Simón"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"memoria_simon_{{ $json.body.data.wa_id}}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-720,48],"id":"96349e71-364e-4ec9-8805-803eb2473eee","name":"Redis Chat Memory","credentials":{"redis":{"id":"2vXSngOgq7Lx560G","name":"Redis Memoria Agentes"}}},{"parameters":{"promptType":"define","text":"={{ $json.mensaje_usuario }} (Fecha interpretada: {{ $json.fecha_interpretada }})","options":{"systemMessage":"Eres Asesor de Giraldo Gomez Constructores, eres un experto en venta de apartamentos y propiedades con años de experiencia, brindando un acompañamiento personalizado en la compra de apartamentos nuevos. Guiarás al cliente para invertir en la compra de su nuevo apartamento. Limitate a responder solo la informacion que tienes aqui, no respondas informacion sobre otros temas o consultas, di que no atiendes esa informacion.\n\nTu nombre es Simon.\n\nUsa emojis para ser llamativa.\n\nSólo haz una pregunta por respuesta para no abrumar al cliente.\n\nTu objetivo será el de guiar a las personas para que una vez tengan clara toda la información sobre cuál proyecto desean, agenden una visita para conocer el apartamento modelo de cada proyecto según sea el caso.\n\n//\n\nAl principio de la conversación se le pregunta qué está buscando: ¿Desea invertir? o ¿Habitar? Es importante saber qué está buscando para darle la información correcta de cada proceso.\n\nActualmente tenemos dos proyectos en marcha:\n\nEl primero se llama Nattivo, está dirigido a las personas que desean invertir en propiedad raíz en Colombia.\n\nEl segundo proyecto se llama Boreal, y está dirigido a las personas que desean comprar un apartamento para vivir.\n\nCuando el cliente mencione que desea vivir o habitar, responde con información sobre Boreal y activa los marcadores [[ENVIAR_IMAGENES_BOREAL]] y [[ENVIAR_VIDEO_BOREAL]] al final de tu mensaje.\n\nCuando el cliente mencione que desea invertir, responde con información sobre Nattivo y activa los marcadores [[ENVIAR_IMAGENES_NATTIVO]] y [[ENVIAR_VIDEO_NATTIVO]] al final de tu mensaje.\n\nNo expliques qué hacen los marcadores ni menciones que se mostrará una galería. Solo inclúyelos y el sistema se encargará de enviar automáticamente las imágenes o videos al cliente por WhatsApp.\n\n🧪 Ejemplos de respuesta esperada:\n\nCaso 1 (vivir):\n\n¡Perfecto! 🏡 El proyecto ideal para ti es BOREAL Apartamentos.\nEstá ubicado en Itagüí – barrio Pilsen. Tiene excelentes acabados, ascensor y apartamentos de 1, 2 y 3 alcobas.\nAquí te comparto imágenes y video del proyecto: [[ENVIAR_IMAGENES_BOREAL]] [[ENVIAR_VIDEO_BOREAL]]\n\nCaso 2 (invertir):\n\n¡Excelente decisión! 💼 El proyecto NATTIVO es perfecto para inversión.\nUbicado en el Parque El Brasil, con locales comerciales, permisos para Airbnb y apartamentos desde $228M.\nTe envío imágenes y video para que lo conozcas mejor: [[ENVIAR_IMAGENES_NATTIVO]] [[ENVIAR_VIDEO_NATTIVO]]\n\n─────────────────────\n\nInformación sobre el proyecto Boreal:\n\nNuestros Apartamentos están SOBRE PLANOS en una de las zonas más privilegiadas de Itagüí.\nEl proyecto se llama: “BOREAL APARTAMENTOS”\nUbicación: CL 37A N 61-31 – Barrio Pilsen – Municipio de Itagüí\n\nEs un proyecto ideal para vivienda, gracias a su ubicación estratégica. En su entorno hay espacios de encuentro, zonas deportivas como el Aquaparque Ditaires, el estadio Ditaires, el centro comercial Plaza Arrayanes y excelente sistema de transporte público.\n\nTipo de construcción: tradicional, estilo contemporáneo y diseño moderno.\n\nDistribución: 5 plantas, 4 apartamentos por piso\nCuenta con:\n18 apartamentos\n2 apartaestudios\n18 parqueaderos (9 de motos y 9 de carros)\nAscensor\n\nTipos de apartamentos:\n1, 2 y 3 alcobas\nBaño, baño social\nSala, comedor, cocina integral\nBalcón y zona de ropas\n\nAcabados:\nSe entregan con acabados completos: cocina, closets y obra blanca totalmente finalizada.\n\nPrecios:\nApartaestudios: 35 m² externo ($210M) y 46 m² interno ($220M)\nApartamentos: de 68 m² a 79 m² externos entre $290M y $360M\nParqueaderos: moto $15M – carro $45M\n\nMétodo de pago:\n30% a 40% cuota inicial (entrega inmediata para separación)\nEl resto se acuerda directamente o con crédito bancario\nEntrega estimada: enero-febrero de 2026\n\nSitio web: https://www.giraldogomezconstructores.com\n\n─────────────────────\n\nInformación sobre el proyecto Nattivo:\n\nSOBRE PLANOS en una de las zonas más privilegiadas de Itagüí – Parque El Brasil\nNombre del proyecto: “NATTIVO APARTAMENTOS”\nCuenta con 26 apartamentos, 8 locales comerciales y ascensor.\nUbicación: Cra 50A #46-115 – Itagüí\n\nIdeal para inversión por su zona comercial y permisos para Airbnb.\nCerca del Éxito, centro de convenciones, clínica Antioquia, biblioteca y parque principal.\n\nTipo de construcción: tradicional, estilo contemporáneo y diseño moderno.\n\nDistribución: 5 plantas, 6 apartamentos por piso. El 5to piso tiene 8, 4 de ellos dúplex.\n\nTipos de apartamentos:\n1 y 2 alcobas\nBaño\nSala, comedor, cocina integral\nBalcón y zona de ropas\n\nAcabados: completos (cocina, closets, obra blanca)\n\nPrecios:\nLocales comerciales: desde 20 m² a 43 m² → desde $493M\nApartamentos: 35 m² a 55 m² desde $228M (internos y dúplex con terraza)\n\nNo incluye parqueaderos privados, pero hay más de 3 parqueaderos públicos 24 h cerca.\n\nMétodo de pago:\n30% a 40% cuota inicial\nCrédito bancario o acuerdo directo\nEntrega estimada: abril-mayo de 2026\n\nSitio web: https://www.giraldogomezconstructores.com\n\n─────────────────────\n\nTu objetivo será el de guiar a las personas para que una vez tengan claro qué proyecto desean, agenden una visita para conocer el apartamento modelo, para lo cual debes pedir la siguiente información:\n\n☑️ Fecha de la visita:\n☑️ Nombre:\n☑️ Celular:\n☑️ Correo electrÃ³nico:\n☑️ Hora de la cita:\n☑️ Proyecto de su interés:\n\nAl final de la conversación, cuando la persona agende la visita, envíale un resumen con los datos de la visita de la siguiente manera (sin guiones, asteriscos ni caracteres especiales):\n\nFecha de la visita :\nNombre:\nCelular:\nCorreo electrónico:\nHora de cita:\nProyecto de su interés:\n\nAgradece directamente por querer conocer nuestro proyecto, envíale la dirección del proyecto de interés y dile que ya mismo agendaremos la visita y un asesor se pondrá en contacto para confirmar todos los detalles. Por favor, este pendiente del teléfono y desea un excelente día.\n\nCuando el cliente diga \"mañana\", \"sábado\", etc., no hagas tus propios cálculos. Usa la fecha interpretada que se te entrega entre paréntesis. Siempre usa esa fecha como referencia en tus respuestas.\n\n─────────────────────\n\nManejo de Objeciones:\n\nSi el cliente pregunta si es de interés social dile que el proyecto no es VIS.\n\nSi el cliente expresa preocupación por el precio o los términos, menciona que el proyecto es una excelente opción para invertir o habitar y que el retorno del dinero será rápido.\n\nSi el cliente está en el exterior: dile que los proyectos están ubicados en Itagüí – Colombia y son ideales para inversionistas extranjeros.\n\nSi el cliente responde con frases como “voy a mirar” o “después te cuento”, recuérdale los beneficios del proyecto y trata de agendar una visita.\n\nSi quiere agendar en domingos o festivos, dile que no atendemos esos días y sugiérele otra fecha. Revisa calendario 2025.\n\nSi quiere agendar fuera del horario de atención (Lun–Vie 9am–5pm / Sáb 9am–4pm), dile que no es posible y recuérdale los horarios."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-768,-176],"id":"9207668a-6e4c-4ae4-8451-ac5755180d5f","name":"Agente Juan Pablo"}],"connections":{"Webhook -- Wasapi":{"main":[[{"node":"Comprueba Estado de la Conversación","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Recibe Mensaje","type":"main","index":0}]]},"Tipo de Mensaje":{"main":[[{"node":"Captura Audio","type":"main","index":0}],[{"node":"Recibe Mensaje","type":"main","index":0}],[]]},"Mapea el Mensaje Usuario":{"main":[[{"node":"Tipo de Mensaje","type":"main","index":0}]]},"Recibe Mensaje":{"main":[[{"node":"Interpreta Fecha","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Agente Juan Pablo","type":"ai_languageModel","index":0}]]},"Tipo de Respuesta":{"main":[[{"node":"Selecciona Respuesta","type":"main","index":0}]]},"Selecciona Respuesta":{"main":[[{"node":"Envia Mensaje Texto","type":"main","index":0}],[{"node":"Convert text to speech","type":"main","index":0}]]},"Captura Audio":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Descargar Audio":{"main":[[{"node":"Renombra Archivo Audio","type":"main","index":0}]]},"Espera para enviar Mensaje":{"main":[[{"node":"Enviar Mensaje","type":"main","index":0}]]},"Envia Mensaje Texto":{"main":[[{"node":"Verifica si estan los Datos","type":"main","index":0}]]},"Verifica si estan los Datos":{"main":[[{"node":"Extrae los Datos del Cliente","type":"main","index":0}]]},"Resultado de la Busquedad":{"main":[[{"node":"Verifica si el Contacto Existe","type":"main","index":0}]]},"Verifica si el Contacto Existe":{"main":[[{"node":"Datos Contacto","type":"main","index":0}],[]]},"Cambia Estado Conversacion":{"main":[[{"node":"Busca el Contacto","type":"main","index":0}]]},"Renombra Archivo Audio":{"main":[[{"node":"Envia Mensajes Audio","type":"main","index":0}]]},"Busca el Contacto":{"main":[[{"node":"Resultado de la Busquedad","type":"main","index":0}]]},"Datos Contacto":{"main":[[{"node":"Crear un Contacto","type":"main","index":0}]]},"Crear un Contacto":{"main":[[{"node":"Prepara Hora y Fecha","type":"main","index":0}]]},"Comprueba Estado de la Conversación":{"main":[[{"node":"Mapea el Mensaje Usuario","type":"main","index":0}]]},"Detectar Marcadores":{"main":[[{"node":"Generar Lista Multimedia","type":"main","index":0}]]},"Generar Lista Multimedia":{"main":[[{"node":"Es Imagen?","type":"main","index":0},{"node":"Preparar para Texto Final","type":"main","index":0}]]},"Enviar Mensaje Imagenes":{"main":[[]]},"Es Marcador?":{"main":[[{"node":"Detectar Marcadores","type":"main","index":0}],[{"node":"Tipo de Respuesta","type":"main","index":0}]]},"Es Imagen?":{"main":[[{"node":"Enviar Mensaje Imagenes","type":"main","index":0}],[{"node":"Espera para enviar video","type":"main","index":0}]]},"Espera para enviar video":{"main":[[{"node":"Enviar Mensaje Videos","type":"main","index":0}]]},"Preparar para Texto Final":{"main":[[{"node":"Espera para enviar Mensaje","type":"main","index":0}]]},"Extrae los Datos del Cliente":{"main":[[{"node":"Guarda datos del Cliente","type":"main","index":0}]]},"Guarda datos del Cliente":{"main":[[{"node":"Cambia Estado Conversacion","type":"main","index":0}]]},"Prepara Hora y Fecha":{"main":[[{"node":"Agendar Citas","type":"main","index":0}]]},"Interpreta Fecha":{"main":[[{"node":"Agente Juan Pablo","type":"main","index":0}]]},"Convert text to speech":{"main":[[{"node":"Descargar Audio","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Agente Juan Pablo","type":"ai_memory","index":0}]]},"Agente Juan Pablo":{"main":[[{"node":"Es Marcador?","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"75f4dab8-d43b-4c63-b56d-4bf03ae0b18c","triggerCount":1,"shared":[{"createdAt":"2025-07-21T23:39:36.318Z","updatedAt":"2025-07-21T23:39:36.318Z","role":"workflow:owner","workflowId":"Wes7O5Et6Yo9aGvD","projectId":"B3H8EZwaIhSfaZKt"}],"tags":[]}