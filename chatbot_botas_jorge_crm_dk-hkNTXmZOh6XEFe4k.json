{"createdAt":"2025-08-29T19:21:42.460Z","updatedAt":"2025-10-01T20:05:38.000Z","id":"hkNTXmZOh6XEFe4k","name":"Chatbot_Botas_Jorge_CRM_DK","active":true,"isArchived":false,"nodes":[{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"771e410e-f57d-475d-946b-bf21b70fe136","leftValue":"={{ $json.action }}","rightValue":"ACCION_ENVIAR_IMAGENES","operator":{"type":"string","operation":"equals"}}],"combinator":"or"},"options":{}},"name":"¿Pide Imagen?","type":"n8n-nodes-base.if","typeVersion":2,"position":[0,240],"id":"8400eed3-11c9-462b-92af-c25fc390a464"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"334eb726-7674-4f91-beb1-16da6d8d0eb3","leftValue":"={{ $json.file_type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.content_type }}{{ $json.file_type }}","rightValue":"text","operator":{"type":"string","operation":"equals"},"id":"b055bc2e-a7e7-402f-a616-6c42b02dd4a1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3cdaedde-990e-4104-a236-bc5d9806fa55","leftValue":"={{ $json.file_type }}","rightValue":"image","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagen"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-2032,192],"id":"90bb1f1b-e121-41ef-a339-624d6f4dd474","name":"Tipo de Mensaje"},{"parameters":{"assignments":{"assignments":[{"id":"3b47ea5a-a76c-4160-a88d-d685658c200d","name":"body","value":"={{ $json.body }}","type":"string"},{"id":"d550409f-9300-49ab-b18b-63ce3629a4bc","name":"type","value":"={{ $json.body.messages[0].message_type }}","type":"string"},{"id":"27d2c7af-747b-4849-925b-08246cb276db","name":"message","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"61b336dd-b2b2-4332-904e-1a8b68157a24","name":"number","value":"={{ $json.body.messages[0].conversation.contact_inbox.source_id }}","type":"number"},{"id":"ec3767d4-ac1d-4ea0-8807-f197f191fe94","name":"content_type","value":"={{ $json.body.messages[0].content_type }}","type":"string"},{"id":"826b1e46-ab86-459c-b044-3a0890dbc36c","name":"account_id","value":"={{ $json.body.messages[0].account_id }}","type":"string"},{"id":"efcb4742-d5cb-4018-82b1-dc09a519f5f9","name":"conversation_id","value":"={{ $json.body.messages[0].conversation_id }}","type":"string"},{"id":"9b76e155-5602-4d2c-96a6-e044aad11893","name":"messages_acount","value":"={{ $json.body.first_reply_created_at }}","type":"string"},{"id":"4c3c343e-9126-48d7-9d82-230f15b96e9c","name":"file_type","value":"={{ $json.body.messages[0].attachments[0].file_type }}","type":"string"},{"id":"f8966f03-f891-4913-aeac-b43cb9d3126c","name":"data_url","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2224,208],"id":"fb5a7701-4a91-434e-9974-580bc3a75f48","name":"Mapea el Mensaje Usuario"},{"parameters":{"values":{"string":[{"name":"number","value":"={{ $('Mapea el Mensaje Usuario').item.json.number }}  "},{"name":"mensaje_usuario","value":"={{ $json.mensaje_usuario }}"},{"name":"account_id","value":"={{ $('Mapea el Mensaje Usuario').item.json.account_id }}"},{"name":"conversation_id","value":"={{ $('Mapea el Mensaje Usuario').item.json.conversation_id }}"}],"number":[{"name":"messages_acount","value":"={{ $('Mapea el Mensaje Usuario').item.json.messages_acount }}"}]},"options":{}},"name":"Recibe Mensaje","type":"n8n-nodes-base.set","typeVersion":2,"position":[-1136,224],"id":"5540457f-9ab9-4184-962b-2c4fca239fbb"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.content.parts[0].text }}","rightValue":"Texto","operator":{"type":"string","operation":"contains"},"id":"0f070bd9-c076-4298-bfd4-8f81f87a4494"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c5f99960-651b-443a-87ff-54d6232af484","leftValue":"={{ $json.content.parts[0].text }}","rightValue":"Audio","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[752,256],"id":"361a5aef-f132-4a58-a62a-76d8587ece77","name":"Selecciona Respuesta"},{"parameters":{"jsCode":"const baseUrl = \"https://grupodksoluciones.com/imgnobuck/\";\nconst total = 4;\n\nlet items = [];\n\nfor (let i = 1; i <= total; i++) {\n  items.push({\n    json: {\n      nombre: `${i}.png`,\n      url: `${baseUrl}${i}.png`\n    }\n  });\n}\n\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[256,-304],"id":"790d805f-3da7-4c24-a924-f4c0ad6c5ef4","name":"Subir Imagenes"},{"parameters":{"operation":"write","fileName":"=/files/audios/audio.mp3","options":{}},"type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[1168,272],"id":"015f0a7a-da3c-4f97-80da-2909fd15c0be","name":"Descargar Audio"},{"parameters":{"amount":8},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[288,-96],"id":"e489c80f-2c88-4920-ad52-c56da3f993ab","name":"Espera para enviar Mensaje","webhookId":"0b5ce635-e37c-4c70-8489-2cc2bafdfbdd"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $('Analiza Respuesta del Agente').item.json.message }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1024,32],"id":"a11cb0fa-0fd1-4388-bbf0-5f01950fd3f1","name":"Envia Mensaje Texto"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c6f97ebd-22b9-43a2-8611-23883d460893","leftValue":"={{ $json.content }}","rightValue":"Ya mismo subiremos tu pedido","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1264,32],"id":"e0147c6c-4705-41d5-ac3a-f327882135d1","name":"Verifica si estan los Datos"},{"parameters":{"jsCode":"// El texto del mensaje está directamente en la propiedad 'content'\nconst mensaje = $json.content;\n\n// Objeto para almacenar los datos extraídos\nconst datos = {};\n\n// Expresiones regulares para cada campo.\n// El patrón ( ... || [])[1]?.trim() || '' es una forma segura de extraer:\n// 1. Busca el patrón.\n// 2. Si no lo encuentra, usa un array vacío para evitar errores.\n// 3. Toma el primer grupo capturado (lo que está en paréntesis).\n// 4. Usa '?.' para evitar error si el grupo no existe.\n// 5. Usa .trim() para limpiar espacios en blanco.\n// 6. Si todo lo anterior falla, devuelve una cadena vacía ''.\ndatos.fecha = new Date().toLocaleDateString('es-CO');\ndatos.nombre = (mensaje.match(/Nombre Completo:\\s*(.+)/) || [])[1]?.trim() || '';\ndatos.telefono = (mensaje.match(/Teléfono:\\s*(\\d+)/) || [])[1]?.trim() || '';\ndatos.ciudad = (mensaje.match(/Ciudad:\\s*(.+)/) || [])[1]?.trim() || '';\ndatos.departamento = (mensaje.match(/Departamento:\\s*(.+)/) || [])[1]?.trim() || '';\ndatos.direccion = (mensaje.match(/Dirección:\\s*(.+)/) || [])[1]?.trim() || '';\ndatos.talla = (mensaje.match(/Talla:\\s*(\\d+)/) || [])[1]?.trim() || '';\ndatos.color = (mensaje.match(/Color:\\s*(.+)/) || [])[1]?.trim() || '';\ndatos.cantidad = (mensaje.match(/Cantidad:\\s*(\\d+)/) || [])[1]?.trim() || '';\n\n// Devuelve los datos en el formato que N8N espera\nreturn [{\n  json: datos\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,16],"id":"d5c45bc3-71c5-4c2a-9644-61ab65dcdaff","name":"Extrae los Datos del Pedido"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"17bhx9dRc_O-mBYZbOVJom3Kq2jxtIcDkBjKVIyHz5F8","mode":"list","cachedResultName":"Control pedidos grupo dk","cachedResultUrl":"https://docs.google.com/spreadsheets/d/17bhx9dRc_O-mBYZbOVJom3Kq2jxtIcDkBjKVIyHz5F8/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":241089549,"mode":"list","cachedResultName":"YYStore","cachedResultUrl":"https://docs.google.com/spreadsheets/d/17bhx9dRc_O-mBYZbOVJom3Kq2jxtIcDkBjKVIyHz5F8/edit#gid=241089549"},"columns":{"mappingMode":"defineBelow","value":{"Fecha":"={{ $json.fecha }}","Nombre Completo":"={{ $json.nombre }}","Telefono":"={{ $json.telefono }}","Ciudad":"={{ $json.ciudad }}","Departamento":"={{ $json.departamento }}","Direccion Completa":"={{ $json.direccion }}","Talla":"={{ $json.talla }}","Color":"={{ $json.color }}","Cantidad":"={{ $json.cantidad }}"},"matchingColumns":[],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Nombre Completo","displayName":"Nombre Completo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Ciudad","displayName":"Ciudad","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Departamento","displayName":"Departamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Direccion Completa","displayName":"Direccion Completa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Talla","displayName":"Talla","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Color","displayName":"Color","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Cantidad","displayName":"Cantidad","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Guia","displayName":"Guia","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Ref","displayName":"Ref","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Valor","displayName":"Valor","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Flete","displayName":"Flete","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"plata aveo ","displayName":"plata aveo ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Reinversion","displayName":"Reinversion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Ganancia para nosotros","displayName":"Ganancia para nosotros","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Observaciones","displayName":"Observaciones","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"GuiaEnviada","displayName":"GuiaEnviada","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"WhatsApp","displayName":"WhatsApp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Estado ","displayName":"Estado ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Guia pagada ","displayName":"Guia pagada ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Pickig packing","displayName":"Pickig packing","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"Guia","displayName":"Guia","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[1712,16],"id":"64d8d634-6409-42c0-96fd-c50a814ec53c","name":"Agrega Pedido Nuevo Hoja de Excel","credentials":{"googleSheetsOAuth2Api":{"id":"qqcpJ74batXzJmOW","name":"Google Sheets Laura DK"}}},{"parameters":{"jsCode":"// Obtener el número desde el nodo \"Mapea el Mensaje Usuario\"\nlet numeroOriginal = $('Mapea el Mensaje Usuario').first().json.number || '';\n\n// Convertir a string si no lo es\nif (typeof numeroOriginal !== 'string') {\nnumeroOriginal = String(numeroOriginal);\n}\n\n// Limpiar el número de caracteres no numéricos\nconst numero = numeroOriginal.replace(/\\D/g, '');\n\n// Lista de contactos recibida desde el nodo \"Get many contacts\"\nconst contactos = items;\n\nlet existe = false;\n\nfor (const contacto of contactos) {\nconst telefonos = contacto.json.phoneNumbers?.mobile || [];\nfor (const tel of telefonos) {\nconst telLimpio = String(tel).replace(/\\D/g, '');\nif (telLimpio === numero) {\nexiste = true;\nbreak;\n}\n}\nif (existe) break;\n}\n// Devolver resultado para el nodo IF\nreturn [{ json: { existe } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3184,16],"id":"038b3f01-5b50-4d56-b74d-30725177c309","name":"Resultado de la Busquedad"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"01bb1256-606c-4108-ab62-19d62cb2086c","leftValue":"={{ $json.existe }}","rightValue":"false","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3424,16],"id":"437aff31-0e91-478a-894c-dbb7bd3be34a","name":"Verifica si el Contacto Existe"},{"parameters":{"resource":"audio","input":"={{ $('Agente Sofia').item.json.output }}","voice":"shimmer","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[992,272],"id":"01b87a75-9fa0-4a13-9c7f-2e71eebc54f4","name":"Genera el audio","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}},"disabled":true},{"parameters":{"command":"sh /files/audios/renombrar_audio.sh"},"type":"n8n-nodes-base.executeCommand","typeVersion":1,"position":[1376,272],"id":"3d1901df-18d3-447a-af4d-29404f40013a","name":"Renombra Archivo Audio"},{"parameters":{"operation":"getAll","returnAll":true,"fields":["phoneNumbers","names"],"options":{}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[2992,16],"id":"bcdbaaa7-2910-4e61-9205-bf1ab61846ab","name":"Busca el Contacto","credentials":{"googleContactsOAuth2Api":{"id":"uV9tgeco0YQSxoVN","name":"Google Contacts Prostagen"}}},{"parameters":{"jsCode":"// Obtener datos desde los nodos anteriores\nconst nombre = $node[\"Extrae los Datos del Pedido\"].json.nombre;\nconst celular = $node[\"Mapea el Mensaje Usuario\"].json.number;\n\nreturn [\n  {\n    json: {\n      nombre,\n      celular\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3696,0],"id":"a77cc2f2-ef12-4c6b-a6d1-d1bb6f7bc99b","name":"Datos Contacto"},{"parameters":{"familyName":"=","givenName":"={{ $json.nombre }}","additionalFields":{"phoneUi":{"phoneValues":[{"type":"mobile","value":"=+{{ $json.celular }}"}]}}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[3936,0],"id":"9ccb82ef-c8cc-49d3-9bde-873796593bf2","name":"Crear un Contacto","credentials":{"googleContactsOAuth2Api":{"id":"uV9tgeco0YQSxoVN","name":"Google Contacts Prostagen"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"=memoria_sofia_{ $('Recibe Mensaje').item.json.conversation_id }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-560,480],"id":"1def83a8-254b-418f-a83c-6bb0c7b6c57f","name":"Redis Chat Memory","credentials":{"redis":{"id":"x55J5q5RmLVSd9Pd","name":"Chat Memory Local"}}},{"parameters":{"httpMethod":"POST","path":"linea_ventas_jorge","options":{}},"name":"Webhook -- CRM DK","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-2720,224],"id":"45ce48c4-758d-4abc-bd29-ba3280a2f4d5","webhookId":"e60d9a26-5b10-48b7-afef-ae66e00539fd"},{"parameters":{"url":"={{ $json.url }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,-304],"id":"d7458184-9d45-4611-94a2-969d1e5d82c2","name":"Descargar Imagen"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Webhook -- CRM DK').item.json.body.messages[0].account_id }}/conversations/{{ $('Webhook -- CRM DK').item.json.body.messages[0].conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"attachments[]","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[704,-304],"id":"15df98e1-ae5d-4f3b-adab-0f83e915c361","name":"Envia Imagenes"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Webhook -- CRM DK').item.json.body.messages[0].account_id }}/conversations/{{ $('Webhook -- CRM DK').item.json.body.messages[0].conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $('Agente Sofia').item.json.output }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1600,272],"id":"04d63e03-936a-44a6-a981-fd91f662262c","name":"Envia Mensaje Audio"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/toggle_status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"=open"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2128,16],"id":"a967c9c0-a086-47aa-b4e1-8c21be6c013d","name":"Cambia Estado"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/assignments","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"assignee_id","value":"=3"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1920,16],"id":"414936b9-d60b-44dc-9dc5-8f555f14073b","name":"Asignar Agente"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"74b0586a-ada7-4619-9da6-3da09bcb5f01","leftValue":"={{ $json.body.messages[0].conversation.assignee_id }}","rightValue":0,"operator":{"type":"number","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2480,224],"id":"58de5f55-ae0c-4584-bd2e-06c150aa0421","name":"If"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Webhook -- CRM DK').item.json.body.messages[0].account_id }}/conversations/{{ $('Webhook -- CRM DK').item.json.body.messages[0].conversation_id }}/labels","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"labels","value":"={{ $json.id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2784,16],"id":"ff4cd9ce-1384-4faf-be21-e2213bc3cb74","name":"Añadir Etiqueta"},{"parameters":{"url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Webhook -- CRM DK').item.json.body.messages[0].account_id }}/labels","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2336,16],"id":"f463d275-40b3-4b1d-add7-77cfc8cd2efa","name":"Obtener Etiqueta"},{"parameters":{"jsCode":"// 1. Obtiene el array de etiquetas desde el objeto 'payload' del primer ítem de entrada\nconst labelsList = $input.item.json.payload;\n\n// 2. Define el nombre de la etiqueta que estamos buscando\nconst targetLabelName = \"nuevo-pedido\";\n\n// 3. Busca en la lista la etiqueta que coincida con el nombre\n//    Ahora buscamos en 'labelsList' y accedemos directamente a 'label.title'\nconst foundLabel = labelsList.find(label => label.title === targetLabelName);\n\n// 4. Devuelve el resultado en el formato que n8n espera: un array de items\n//    Cada item debe tener una propiedad 'json' que contenga nuestros datos\nreturn [{ json: foundLabel }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2560,16],"id":"5265f36e-701b-46a2-a531-693b8fe00e78","name":"Encontrar Etiqueta"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"555cb9e3-1961-4990-b2fa-8eb1eece0c3c","leftValue":"={{ $json.messages_acount }}","rightValue":1,"operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-896,224],"id":"99bda9d7-4b95-4c02-9caf-a8ed34375544","name":"¿Es Cliente Nuevo?"},{"parameters":{"jsCode":"const baseUrl = \"https://grupodksoluciones.com/bienvenidanobuck/\";\nconst total = 2;\n\nlet items = [];\n\nfor (let i = 1; i <= total; i++) {\n  items.push({\n    json: {\n      nombre: `${i}.png`,\n      url: `${baseUrl}${i}.png`\n    }\n  });\n}\n\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-432,-224],"id":"cb611c72-5347-4adb-9d43-c2017d50d0bb","name":"Trae Imagen"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"👋 ¡Hola! ¿Cómo estás? 😊 Mi nombre es Sofía 👩‍💼, experta en calzado. ¡Un gusto tenerte por aquí! 🥾✨"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-624,-224],"id":"4426065d-5070-4ebc-8817-f6a704d33fb8","name":"Envia Mensaje Saludo"},{"parameters":{"url":"={{ $json.url }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,-224],"id":"22c62c21-6b28-47ef-b2d9-6e20fcdc7b64","name":"Descarga Imagen"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"attachments[]","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-64,-224],"id":"c7792262-17bc-41f1-9681-b5185aa3b84c","name":"Enviar Imagen"},{"parameters":{"amount":9},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-624,-32],"id":"ba6275c3-b47d-410e-841d-7778fa41fe4c","name":"Retrasa","webhookId":"77f0c466-f122-4567-92bd-0f1af259e40d"},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"💰*Precios :*\n1 X  $134.900 Envío gratis\n2 X $256.000 Envío gratis\n3 X $380.000 Envío gratis\n\n📏 *Tallas disponibles:* De la  36 a la 44\n\n😍*Colores disponibles:* Marron. \n\n*TENEMOS PAGO CONTRAENTREGA A NIVEL NACIONAL*\n\n¿En qué ciudad te encuentras?"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-416,-32],"id":"55f14e9a-37c1-402a-8415-3d5d3d551cc6","name":"Envia Mensaje Bienvenida"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"models/gemini-2.5-pro","mode":"list","cachedResultName":"models/gemini-2.5-pro"},"text":"Analiza la siguiente imagen de una bota. Tu tarea tiene dos partes:\n1.  Lee cualquier texto visible en la imagen.\n2.  Identifica el color principal de la bota (solo puede ser \"marrón\").\n\nTu única respuesta debe ser un texto que combine ambas informaciones en el siguiente formato exacto: \"[Texto leído] color [Color identificado]\".\n\nEjemplos:\n- Si la foto es de una bota y la bota es marrón, tu respuesta debe ser: \"Bota Nobuck color marrón\".\n\nNo añadas ninguna palabra, saludo o explicación adicional.","imageUrls":"={{ $json.data_url }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-1712,384],"id":"dd0b11fc-b735-4863-818b-cad436a24466","name":"Analyze image","credentials":{"googlePalmApi":{"id":"q5nEB1oUJP3rMj76","name":"Google Gemini"}}},{"parameters":{"method":"POST","url":"=https://crm.enterprisetecno.com/api/v1/accounts/{{ $('Recibe Mensaje').item.json.account_id }}/conversations/{{ $('Recibe Mensaje').item.json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"7LcL1q3x4hgGCVnaiGepLzNm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $('Analiza Respuesta del Agente').item.json.message }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[528,-96],"id":"326cf2a8-6fb0-4417-833e-5f231b5e524c","name":"Envia Mensaje Imagenes"},{"parameters":{"jsCode":"// Obtenemos la salida de texto del Agente Laura\nconst outputString = items[0].json.output;\n\n// Valores por defecto por si la IA responde con texto plano\nlet finalAction = 'ACCION_ENVIAR_TEXTO';\nlet finalMessage = outputString;\n\n// Expresión regular para buscar y extraer el valor de la clave \"action\"\nconst actionRegex = /\"action\":\\s*\"([^\"]*)\"/;\n// Expresión regular para buscar y extraer el valor de la clave \"message\"\n// Esta versión maneja texto de múltiples líneas y caracteres especiales\nconst messageRegex = /\"message\":\\s*\"([\\s\\S]*?)\"\\s*}/;\n\nconst actionMatch = outputString.match(actionRegex);\nconst messageMatch = outputString.match(messageRegex);\n\n// Si encontramos AMBOS valores, significa que la IA nos dio el JSON\nif (actionMatch && messageMatch) {\n  finalAction = actionMatch[1];\n  // El [1] se refiere al texto capturado dentro de los paréntesis en el regex\n  finalMessage = messageMatch[1];\n}\n\n// Devolvemos el objeto final, limpio y estructurado\nreturn [{\n  json: {\n    action: finalAction,\n    // Limpiamos la salida por si acaso, eliminando caracteres de escape\n    message: finalMessage.replace(/\\\\n/g, '\\n').trim()\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-208,240],"id":"76a32774-0173-4b43-8bf3-53e52731423d","name":"Analiza Respuesta del Agente"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-752,464],"id":"43e44215-e6bb-41d0-8d59-d87deab80793","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"q5nEB1oUJP3rMj76","name":"Google Gemini"}}},{"parameters":{"resource":"audio","modelId":{"__rl":true,"value":"models/gemini-1.5-flash","mode":"list","cachedResultName":"models/gemini-1.5-flash"},"audioUrls":"={{ $json.data_url }}","simplify":false,"options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-1712,64],"id":"70bae60d-6037-4485-95b8-d4aeea2d90d9","name":"Transcribe a Audios","credentials":{"googlePalmApi":{"id":"q5nEB1oUJP3rMj76","name":"Google Gemini"}}},{"parameters":{"modelId":{"__rl":true,"value":"models/gemini-1.5-pro","mode":"list","cachedResultName":"models/gemini-1.5-pro"},"messages":{"values":[{"content":"En base a la respuesta recibida, determina si la respuesta deberíamos dársela en formato audio o formato texto.\n\nTrata de enviar el 0% de las veces un audio y 100% texto. resérvate el texto para cuando te pida en el mensaje explícitamente que le envíes un texto y para cuando en el mensaje se detalle mucha información sobre el programa, los módulos, etc... y supere la capacidad de tamaño permitida por la plataforma que es de 2MB\n\nSimplemente responde: \"Audio\" o \"Texto\""}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[352,256],"id":"a88521cb-0e2a-415e-85d7-b2cd8d87313a","name":"Tipo de Respuesta2","credentials":{"googlePalmApi":{"id":"q5nEB1oUJP3rMj76","name":"Google Gemini"}}},{"parameters":{"jsCode":"// Obtenemos los datos de las tres posibles entradas (inputs).\nconst textInput = items.find(item => item.json.message !== undefined);\nconst audioInput = items.find(item => item.json.candidates?.[0]?.content?.parts?.[0]?.text);\n// CORRECCIÓN: La ruta para la imagen es más directa, sin \"candidates\".\nconst imageInput = items.find(item => item.json.content?.parts?.[0]?.text);\n\nlet mensajeUnificado = '';\n\n// Verificamos cuál de las entradas tiene datos y extraemos el mensaje.\nif (textInput) {\n  mensajeUnificado = textInput.json.message;\n} \nelse if (audioInput) {\n  mensajeUnificado = audioInput.json.candidates[0].content.parts[0].text;\n} \nelse if (imageInput) {\n  // CORRECCIÓN: Usamos la ruta correcta para la imagen.\n  mensajeUnificado = imageInput.json.content.parts[0].text;\n}\n\n// Devolvemos un nuevo objeto con la variable estandarizada.\nreturn [{\n  json: {\n    mensaje_usuario: mensajeUnificado\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1344,224],"id":"463f3ac2-eace-48ef-a967-88d177ff0f29","name":"Recollector Datos"},{"parameters":{"promptType":"define","text":"={{ $json.mensaje_usuario }}","options":{"systemMessage":"## REGLAS DE SALIDA (MÁXIMA PRIORIDAD)\nTu tarea más importante es analizar la intención del cliente y responder en formato JSON. Tu respuesta DEBE ser un objeto JSON con dos claves: \"action\" y \"message\".\n\n- Si el cliente pide explícitamente \"fotos\", \"foto\", \"catálogo\", \"catalogo\", \"catálogos\" o \"catalogos\", la clave \"action\" DEBE ser \"ACCION_ENVIAR_IMAGENES\" y la clave \"message\" DEBE ser \"Estas son las fotos de las botas Nobuck 👌. ¿Deseas realizar tu pedido?\".\n- Para cualquier otra pregunta o comentario, la clave \"action\" DEBE ser \"ACCION_ENVIAR_TEXTO\" y la clave \"message\" DEBE ser tu respuesta normal siguiendo tus otras instrucciones.\n\nEjemplo de respuesta si piden fotos:\n{\n  \"action\": \"ACCION_ENVIAR_IMAGENES\",\n  \"message\": \"Estas son las fotos de las botas en cuero 👌. ¿Que talla estas buscando?\"\n}\n\nEjemplo de respuesta si preguntan por tallas:\n{\n  \"action\": \"ACCION_ENVIAR_TEXTO\",\n  \"message\": \"¡Claro! Manejamos de la talla 36 a la 43. ¿Qué talla estás buscando?\"\n}\n\n## IDENTIDAD Y OBJETIVO PRINCIPAL\nEres Sofia, una experta en Ventas de calzado que vende botas en cuero. Tu objetivo principal es tomar los pedidos de los clientes.\n\n---\n\n## INSTRUCCIONES GENERALES DE CONVERSACIÓN\nUsa emojis para ser llamativa.\nRecuerda que manejamos solo el color café oscuro.\nSólo haz una pregunta por respuesta para no abrumar al cliente.\nSiempre empieza la conversación (después de la bienvenida) realizando la siguiente pregunta: ¿En qué ciudad te encuentras?\nSiempre realiza una pregunta de cierre, aquí algunos ejemplos:\n- ¿En qué ciudad te encuentras?\n- ¿Deseas realizar tu pedido?\n-¿Qué talla estás buscando?\nSi el cliente pide fotos o catalogo, dile que estas enviando las fotos y despues de enviar las fotos, envia una pregunta de cierre.\nsi el cliente pregunta que si es solo de mujer le dices que es unisex es tanto para hombres como para mujeres.\nNo debes confirmar la ciudad ni preguntar varias veces en que ciudad se encuentra el cliente, solo sigue con la conversación.\nDespués de que el cliente menciona la ciudad confírmale que tenemos envío GRATIS contra entrega y muy importante proceder a compartir los precios y hacer preguntas durante el chat que eleven el nivel de conciencia del cliente para cerrar la venta.\nsi el cliente te pregunta por más colores dile que solo manejamos en color marron, no tenemos mas colores.\nSi el cliente solicita que le envien fotos, foto, catálogo o catalogo y en el contenido del mensaje existen estas palabras sin importar si esta escrita con mayusculas o minusculas, deja que el flujo de Make envie las fotos, no responda nada adicional a este mensaje, tampoco envíe los enlaces de las imagenes, solo continúa la conversación con el cliente.\nNunca envíe enlaces o links de las imagenes al cliente.\n\n## INSTRUCCIONES PARA TOMAR PEDIDOS\nSi el cliente desea hacer un pedido, finaliza la conversación agradece por la compra y solicita directamente los siguientes datos:\nCuando un cliente exprese interés en realizar su pedido, solicita amablemente la siguiente información para procesar su pedido:\nNombre completo\nTeléfono\nCiudad\nDepartamento\nDirección completa\nTalla\nColor\nCantidad\nNota: Importante, la dirección debe estar completa (al menos que tenga calle o carrera) para poder hacer el pedido sino no se puede ya que la transportadora pide dirección completa.\n\n## REGLAS CRÍTICAS PARA LA FINALIZACIÓN DE PEDIDOS (MÁXIMA PRIORIDAD)\n**Esta es tu instrucción más importante.** Una vez que le hayas solicitado los datos al cliente y el cliente te responda con **TODA** la información que pediste (Nombre, Teléfono, Dirección, ciudad, talla, color, cantidad), tu **ÚNICA Y OBLIGATORIA** siguiente acción es responder con el siguiente mensaje de resumen, palabra por palabra.\n**NO** debes añadir nada más, ni hacer otras preguntas, ni continuar la conversación. Tu única tarea es generar este texto:\n\n**Texto del Resumen del Pedido:**\n\"Perfecto, [Nombre del cliente]. Aquí te resumo tu pedido y datos para el envío:\n- Nombre Completo: [Nombre extraído del mensaje]\n- Teléfono: [Teléfono extraído del mensaje]\n- Dirección: [Dirección extraída del mensaje]\n- Ciudad: [ciudad extraída del mensaje]\n- Departamento: [Departamento extraído del mensaje]\n- Color: [Color extraído del mensaje]\n- Talla: [Talla extraída del mensaje]\n- Cantidad: [Cantidad extraído del mensaje]\n\nGracias por tu compra, [Nombre del cliente]. Ya mismo subiremos tu pedido y apenas se genere la guía de envío te la estaré compartiendo. Por favor, está pendiente del teléfono y asegúrate de tener el pago listo para el mensajero. ¡Que tengas un excelente día! 👢📦✨\"\n\nMantén un tono cordial, profesional y enfocado en brindar una excelente experiencia de compra.\nSi el cliente desea reclamar en oficina por Interrapidisimo muy importante no debes pedir dirección (ni carrera ni calle) ya que no es necesario cuando es para reclamar en oficina y agradece la compra y finaliza el pedido.\nSi el cliente desea reclamar en la Oficina de Interrapidisimo, o expresa la idea que desea que sea entregado en esta oficina de su ciudad, coloca esta información como Dirección Completa, y confirma la ciudad y el departamento para que sea entregado correctamente\nSi el cliente desea reclamar en oficina de Servientrega dile que no tenemos convenio de envíos con Servientrega, solo puede reclamar en una oficina de Interrapidisimo.\nEl barrio es opcional, si el cliente no lo menciona no lo pidas.\nVe agregando la información a medida que la va proporcionando para completar el pedido. Una vez el cliente proporciona los datos necesarios (sin necesidad de los opcionales) agradece directamente por la compra y dile que Ya mismo subiremos tu pedido y apenas se genere la guía de envío te la estaré compartiendo. Por favor, está pendiente del teléfono y asegúrate de tener el pago listo para el mensajero y desea un excelente día.\nSi la persona ya ha enviado sus datos completos para hacer un pedido, eso quiere decir que ya es nuestro cliente, saluda y dale bienvenida amablemente y pregunta si podemos ayudarla en algo o si es posible responde a su pregunta o dile que va contactar con un asesor humano para ayudarle.\n\n## BASE DE CONOCIMIENTO GENERAL\nTallas disponibles:  36 a la 43.\nColores disponibles: marrón \nMaterial: cuero liso.\nDescripción: Bota hecha 100% en cuero liso de excelente calidad, ciento por ciento cuero y suela cocida en pvc ultra resistente, ideal para todo tipo de trabajo. Se puede embetunar para lucir siempre bien. Elaboradas con la mejor tecnología de punta en cuero con los mejores acabados.\nEspecificaciones de las botas en cuero: Suela vulcanizada, material cuero liso, suela cocida resistente y duradera. Es un material resistente, ideal para trabajo en campo y ciudad. Acabados de excelente calidad. cuenta con excelente acabados y excelente costuras.\n\nPrecios:\n1 por ciento diecinueve mil novecientos pesos envío incluido.\n2 por doscientos treinta y nueve mil ochocientos pesos envío incluido.\n3 por trescientos cincuenta y nueve mil setecientos pesos envío incluido.\n\n\nTabla de tallas de las botas en cuero:\n23 centímetros para la talla 36.\n24 centímetros para la talla 37.\n25 centímetros para la talla 38.\n26 centímetros para la talla 39.\n27 centímetros para la talla 40.\n28 centímetros para la talla 41.\n29 centímetros para la talla 42.\n30 centímetros para la talla 43.\n31 centímetros para la talla 44.\n\nPara tallas más grandes de la 44 o más pequeñas de la 36 no tenemos disponible.\n\nPROMOCIÓN INIGUALABLE\n\n🌟💰*SUPER PROMO ESPECIAL \n🌟1 X  $119.900 Envío gratis\n🌟2 X $239.800 Envío gratis\n🌟3 X $359.700 Envío gratis\n\nTodos estos precios ya están con la promoción incluida y actualizada y NO HAY MAS REBAJAS.\n \n # CUENTA DE AHORROS BANCOLOMBIA 01535325894\nambas cuentas bancarias están a nombre de Daniel Esteban Perez\nLos envíos tardan de 2 a 4 días para ciudades capitales y 5 días hábiles para municipios en promedio.\nLos envíos a Medellín duran de 1 a 2 días y las capitales principales de Colombia duran 3 días hábiles. En municipios o otros lugares de Colombia donde exista cobertura el tiempo de entrega es de 3 a 5 días hábiles sin contar sábados, domingos y festivos.\nSi un cliente ya recibió el producto y no está satisfecho, informar amablemente a que espere por resultados. (No ofrecemos devolución del dinero, esto mencionarlo solo si el cliente pregunta).\nInformar al cliente que el producto entregado es el correcto junto con su presentación y que es un producto original y respaldado por expertos.\nSi el cliente pregunta hasta cuando la promoción le dices que se acaba en 24 horas, después llegará a su precio normal que es un 40% más alto.\nSi el cliente pregunta cuánto es la garantía del producto le dices que es de 4 meses.\nSi te piden precios mayoristas o para negocio, debes enviar el siguiente mensaje: Para una cotización como mayorista, escríbenos aquí: https://wa.link/9uc1cg\nSi el cliente pregunta que si son originales le dices que es producto nacional Diseño moderno, originales de propiedad de la marca\nSi el cliente pide número de guía informa que apenas la tengas disponible se la envías.\n¿En dónde están ubicados?: Estamos ubicados en la ciudad de Medellín, pero nuestra tienda es virtual, hacemos envíos a todo el país."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-544,240],"id":"caaec523-ecf1-4a61-ad3f-15a1d6f7ddaa","name":"Agente Sofia"}],"connections":{"¿Pide Imagen?":{"main":[[{"node":"Subir Imagenes","type":"main","index":0},{"node":"Espera para enviar Mensaje","type":"main","index":0}],[{"node":"Tipo de Respuesta2","type":"main","index":0}]]},"Tipo de Mensaje":{"main":[[{"node":"Transcribe a Audios","type":"main","index":0}],[{"node":"Recollector Datos","type":"main","index":0}],[{"node":"Analyze image","type":"main","index":0}]]},"Mapea el Mensaje Usuario":{"main":[[{"node":"Tipo de Mensaje","type":"main","index":0}]]},"Recibe Mensaje":{"main":[[{"node":"¿Es Cliente Nuevo?","type":"main","index":0}]]},"Selecciona Respuesta":{"main":[[{"node":"Envia Mensaje Texto","type":"main","index":0}],[{"node":"Genera el audio","type":"main","index":0}]]},"Subir Imagenes":{"main":[[{"node":"Descargar Imagen","type":"main","index":0}]]},"Descargar Audio":{"main":[[{"node":"Renombra Archivo Audio","type":"main","index":0}]]},"Espera para enviar Mensaje":{"main":[[{"node":"Envia Mensaje Imagenes","type":"main","index":0}]]},"Envia Mensaje Texto":{"main":[[{"node":"Verifica si estan los Datos","type":"main","index":0}]]},"Verifica si estan los Datos":{"main":[[{"node":"Extrae los Datos del Pedido","type":"main","index":0}],[]]},"Extrae los Datos del Pedido":{"main":[[{"node":"Agrega Pedido Nuevo Hoja de Excel","type":"main","index":0}]]},"Agrega Pedido Nuevo Hoja de Excel":{"main":[[{"node":"Asignar Agente","type":"main","index":0}]]},"Resultado de la Busquedad":{"main":[[{"node":"Verifica si el Contacto Existe","type":"main","index":0}]]},"Verifica si el Contacto Existe":{"main":[[{"node":"Datos Contacto","type":"main","index":0}],[]]},"Genera el audio":{"main":[[{"node":"Descargar Audio","type":"main","index":0}]]},"Renombra Archivo Audio":{"main":[[{"node":"Envia Mensaje Audio","type":"main","index":0}]]},"Busca el Contacto":{"main":[[{"node":"Resultado de la Busquedad","type":"main","index":0}]]},"Datos Contacto":{"main":[[{"node":"Crear un Contacto","type":"main","index":0}]]},"Crear un Contacto":{"main":[[]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Agente Sofia","type":"ai_memory","index":0}]]},"Webhook -- CRM DK":{"main":[[{"node":"If","type":"main","index":0}]]},"Descargar Imagen":{"main":[[{"node":"Envia Imagenes","type":"main","index":0}]]},"Cambia Estado":{"main":[[{"node":"Obtener Etiqueta","type":"main","index":0}]]},"Asignar Agente":{"main":[[{"node":"Cambia Estado","type":"main","index":0}]]},"If":{"main":[[{"node":"Mapea el Mensaje Usuario","type":"main","index":0}]]},"Añadir Etiqueta":{"main":[[{"node":"Busca el Contacto","type":"main","index":0}]]},"Obtener Etiqueta":{"main":[[{"node":"Encontrar Etiqueta","type":"main","index":0}]]},"Encontrar Etiqueta":{"main":[[{"node":"Añadir Etiqueta","type":"main","index":0}]]},"¿Es Cliente Nuevo?":{"main":[[{"node":"Envia Mensaje Saludo","type":"main","index":0},{"node":"Retrasa","type":"main","index":0}],[{"node":"Agente Sofia","type":"main","index":0}]]},"Envia Mensaje Saludo":{"main":[[{"node":"Trae Imagen","type":"main","index":0}]]},"Trae Imagen":{"main":[[{"node":"Descarga Imagen","type":"main","index":0}]]},"Descarga Imagen":{"main":[[{"node":"Enviar Imagen","type":"main","index":0}]]},"Enviar Imagen":{"main":[[]]},"Retrasa":{"main":[[{"node":"Envia Mensaje Bienvenida","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"Recollector Datos","type":"main","index":0}]]},"Analiza Respuesta del Agente":{"main":[[{"node":"¿Pide Imagen?","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Agente Sofia","type":"ai_languageModel","index":0}]]},"Transcribe a Audios":{"main":[[{"node":"Recollector Datos","type":"main","index":0}]]},"Tipo de Respuesta2":{"main":[[{"node":"Selecciona Respuesta","type":"main","index":0}]]},"Recollector Datos":{"main":[[{"node":"Recibe Mensaje","type":"main","index":0}]]},"Agente Sofia":{"main":[[{"node":"Analiza Respuesta del Agente","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook -- CRM DK":[{"json":{"headers":{"connection":"Upgrade","host":"n8.enterprisetecno.com","x-real-ip":"212.56.33.215","x-forwarded-for":"212.56.33.215","x-forwarded-proto":"https","content-length":"1859","accept":"application/json","user-agent":"rest-client/2.1.0 (linux x86_64) ruby/3.4.4p34","content-type":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":1681,"contact_id":578,"inbox_id":5,"source_id":"573206179653","created_at":"2025-09-18T11:45:56.636Z","updated_at":"2025-09-18T11:45:56.636Z","hmac_verified":false,"pubsub_token":"yr8HZFcdXzSqytXsxXWd3Xb3"},"id":1727,"inbox_id":5,"messages":[{"id":14571,"content":"¡Hola! Podrías darme más información de...","account_id":3,"inbox_id":5,"conversation_id":1727,"message_type":0,"created_at":1758195956,"updated_at":"2025-09-18T11:45:56.827Z","private":false,"status":"sent","source_id":"wamid.HBgMNTczMjA2MTc5NjUzFQIAEhggQUNBQTk3NzU1MTg4ODREMzJDOTc0MEZBRDc3ODY3ODcA","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":578,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"¡Hola! Podrías darme más información de...","sentiment":{},"conversation":{"assignee_id":null,"unread_count":1,"last_activity_at":1758195956,"contact_inbox":{"source_id":"573206179653"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":578,"identifier":null,"name":"cfelipeandres167","phone_number":"+573206179653","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":578,"identifier":null,"name":"cfelipeandres167","phone_number":"+573206179653","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":1,"first_reply_created_at":null,"priority":null,"waiting_since":1758195956,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1758195956,"timestamp":1758195956,"created_at":1758195956,"updated_at":1758195956.842674,"event":"automation_event.message_created"},"webhookUrl":"https://n8.enterprisetecno.com/webhook/linea_ventas_jorge","executionMode":"production"}}]},"versionId":"f92bcad7-0ebe-4455-bbc1-22ce61108992","triggerCount":1,"shared":[{"createdAt":"2025-08-29T19:21:42.498Z","updatedAt":"2025-08-29T19:21:42.498Z","role":"workflow:owner","workflowId":"hkNTXmZOh6XEFe4k","projectId":"B3H8EZwaIhSfaZKt"}],"tags":[]}