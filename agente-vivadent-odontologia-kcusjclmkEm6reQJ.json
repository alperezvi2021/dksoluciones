{"createdAt":"2025-09-29T11:48:09.374Z","updatedAt":"2025-10-27T00:58:57.000Z","id":"kcusjclmkEm6reQJ","name":"Agente Vivadent Odontologia","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"vivadent_odontologia","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-656,224],"id":"0e062de4-a45e-457e-9743-5e1f9962f354","name":"Webhook -CRM Vivadent","webhookId":"72682a02-1943-4fd8-9843-8aaa70e9a880"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e167d781-a04e-461d-bbd4-560a2cc6240d","leftValue":"={{ $json.body.messages[0].conversation.assignee_id }}","rightValue":"","operator":{"type":"number","operation":"empty","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-416,224],"id":"40812166-46fd-437e-9029-058f8bee8222","name":"Valida ID Conversacion"},{"parameters":{"assignments":{"assignments":[{"id":"73ab740b-41f0-4dde-ab02-717133593150","name":"cuerpo mensaje","value":"={{ $json.body }}","type":"string"},{"id":"0d34e6b9-9569-4172-95ff-d71eb43a65fb","name":"tipo mensaje","value":"={{ $json.body.messages[0].message_type }}","type":"string"},{"id":"165cae54-57c0-4689-8640-f80d0477243c","name":"mensaje","value":"={{ $json.body.messages[0].content }}","type":"string"},{"id":"af4da877-6964-4108-84f3-11f3f1ea7a40","name":"numero","value":"={{ $json.body.messages[0].conversation.contact_inbox.source_id }}","type":"string"},{"id":"1a8e082a-dfce-4bad-bf8c-c49aaca49bb7","name":"tipo contenido","value":"={{ $json.body.messages[0].content_type }}","type":"string"},{"id":"83719895-2fb9-4caa-ba9a-544c18df94c8","name":"cuenta id","value":"={{ $json.body.messages[0].account_id }}","type":"string"},{"id":"5d75a390-ef3a-4198-8857-95a6c1fc845e","name":"conversacion id","value":"={{ $json.body.messages[0].conversation_id }}","type":"string"},{"id":"53d8c8c9-329c-45e7-b119-9bb4d176a3fc","name":"cuenta mensaje","value":"={{ $json.body.first_reply_created_at }}","type":"string"},{"id":"cac889df-acb4-41b4-a04e-a5ff1aa2de51","name":"tipo archivo","value":"={{ $json.body.messages[0].attachments[0].file_type }}","type":"string"},{"id":"eb1e9564-e3ee-4628-8ab1-9c80aef4de5c","name":"data url","value":"={{ $json.body.messages[0].attachments[0].data_url }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-160,208],"id":"84af6338-5ade-43b6-88d0-9d87ed47acea","name":"Mapea Mensaje Usuario"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json['tipo archivo'] }}","rightValue":"audio","operator":{"type":"string","operation":"equals"},"id":"63ed7985-0ebf-4e81-b47e-7e8afe597afb"}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3424304d-0db0-47a8-85b0-b100e52a562b","leftValue":"={{ $json['tipo contenido'] }}{{ $json['tipo archivo'] }}","rightValue":"text","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"31740c9c-7d56-480b-a9c5-6ccbff20b678","leftValue":"={{ $json['tipo archivo'] }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagen"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[64,192],"id":"0c913d35-326c-46ea-8b7a-66b076db98b2","name":"Tipo Mensaje"},{"parameters":{"assignments":{"assignments":[{"id":"1371cdea-08ef-4adb-80a2-4a7d7ba782d0","name":"numero","value":"={{ $('Mapea Mensaje Usuario').item.json.numero }}","type":"string"},{"id":"47f4fd59-c866-49ee-bb12-fe62a8bc6f7b","name":"mensajeusuario","value":"={{ $json.mensaje_usuario }}","type":"string"},{"id":"19dc07cd-7841-4f7d-8ebf-1fddfa4c3d97","name":"cuenta id","value":"={{ $('Mapea Mensaje Usuario').item.json['cuenta id'] }}","type":"string"},{"id":"d7ac9540-765a-4f32-b0bb-2f53b5b272fe","name":"conversacion id","value":"={{ $('Mapea Mensaje Usuario').item.json['conversacion id'] }}","type":"string"},{"id":"f06bf997-3d2f-48f5-bf14-b1b993b4c8d5","name":"cuenta mensaje","value":"={{ $('Mapea Mensaje Usuario').item.json['cuenta mensaje'] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[848,208],"id":"d4ec090b-6147-48ab-a170-37fa5faa4276","name":"Recibe Mensaje"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=memoria_vivadent_{{ $json['conversacion id'] }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[928,480],"id":"13682157-ce9d-46ae-9f3d-d7d149e29458","name":"Redis Chat Memory","credentials":{"redis":{"id":"x55J5q5RmLVSd9Pd","name":"Chat Memory Local"}}},{"parameters":{"method":"POST","url":"=https://crm.vivadentodontologia.online/api/v1/accounts/{{ $('Recibe Mensaje').item.json['cuenta id'] }}/conversations/{{ $('Recibe Mensaje').item.json['conversacion id'] }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"=api_access_token","value":"=UPCzavt6Mfq7V855uGbmKDYe"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.output }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1776,320],"id":"ce07073d-74d3-455a-a56b-0c6d1cf16e03","name":"Envia Mensaje"},{"parameters":{"resource":"audio","modelId":{"__rl":true,"value":"models/gemini-2.5-flash","mode":"list","cachedResultName":"models/gemini-2.5-flash"},"audioUrls":"={{ $json['data url'] }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[336,64],"id":"fc45417b-211c-41bb-8b27-11451f839eac","name":"Transcribe Audio","credentials":{"googlePalmApi":{"id":"fqAagNkEpEri1Av1","name":"Conexiones Grupo DK Soluciones"}}},{"parameters":{"jsCode":"// Obtenemos los datos de las tres posibles entradas (inputs).\n// CORRECCIÃ“N: Se busca \"mensaje\" en lugar de \"message\".\nconst textInput = items.find(item => item.json.mensaje !== undefined);\nconst audioInput = items.find(item => item.json.candidates?.[0]?.content?.parts?.[0]?.text);\nconst imageInput = items.find(item => item.json.content?.parts?.[0]?.text);\n\nlet mensajeUnificado = '';\n\n// Verificamos cuÃ¡l de las entradas tiene datos y extraemos el mensaje.\nif (textInput) {\n  // CORRECCIÃ“N: Se extrae el dato de \"mensaje\".\n  mensajeUnificado = textInput.json.mensaje;\n\n} else if (audioInput) {\n  // CORRECCIÃ“N: Se aÃ±ade \"?.\" (optional chaining) para hacer el cÃ³digo mÃ¡s seguro.\n  mensajeUnificado = audioInput.json.candidates?.[0]?.content?.parts?.[0]?.text;\n\n} else if (imageInput) {\n  // CORRECCIÃ“N: Se aÃ±ade \"?.\" (optional chaining) para hacer el cÃ³digo mÃ¡s seguro.\n  mensajeUnificado = imageInput.json.content?.parts?.[0]?.text;\n}\n\n// Devolvemos un nuevo objeto con la variable estandarizada.\nreturn [{\n  json: {\n    mensaje_usuario: mensajeUnificado\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[608,208],"id":"1600c279-ac9d-4816-933e-7ae44d8a5946","name":"Recolecta Datos"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"models/gemini-2.5-pro","mode":"list","cachedResultName":"models/gemini-2.5-pro"},"text":"[ROL Y OBJETIVO]\nActÃºa como un asistente de triaje visual para \"SofÃ­a\", la asistente del consultorio odontolÃ³gico Vivadent. Tu Ãºnica funciÃ³n es analizar la imagen enviada por un usuario y generar una respuesta corta y segura. Tu objetivo principal NO es describir la imagen en detalle, sino determinar si requiere una valoraciÃ³n profesional y guiar al usuario hacia ella.\n\n[REGLAS FUNDAMENTALES DE SEGURIDAD - Â¡INQUEBRANTABLES!]\n1.  **PROHIBIDO DAR DIAGNÃ“STICOS:** Bajo ninguna circunstancia puedes nombrar condiciones mÃ©dicas (ej. \"caries\", \"gingivitis\", \"infecciÃ³n\").\n2.  **NO SUGERIR TRATAMIENTOS:** No menciones ningÃºn tipo de tratamiento, procedimiento, medicamento o remedio.\n3.  **NO ESPECULAR:** No hagas suposiciones sobre la gravedad, el dolor o la urgencia de lo que ves. Evita frases como \"eso parece grave\" o \"no te preocupes\".\n4.  **MANTENER NEUTRALIDAD:** Describe lo que ves de la forma mÃ¡s general y neutra posible si es necesario (ej. \"una imagen de un diente\", \"una foto de la boca\").\n\n[PROCESO DE RESPUESTA]\n1.  **Analiza la imagen:** Observa el contenido de la imagen proporcionada.\n2.  **Determina la acciÃ³n:**\n    * **CASO A (Imagen Dental/ClÃ­nica):** Si la imagen muestra el interior de una boca, un diente, encÃ­as, o cualquier cosa que parezca una consulta dental, tu respuesta SIEMPRE debe ser la siguiente: \"Gracias por compartir la imagen. Para poder entender tu caso y darte la mejor soluciÃ³n, es indispensable que la Dra. Henao realice una valoraciÃ³n profesional. Â¿Te gustarÃ­a agendar una cita de diagnÃ³stico? Tiene un costo de $20,000.\"\n    * **CASO B (Imagen No Relevante):** Si la imagen no estÃ¡ relacionada con odontologÃ­a (ej. un documento, un paisaje, un objeto), tu respuesta debe ser: \"He recibido tu imagen. Soy SofÃ­a, la asistente de Vivadent. Â¿CÃ³mo puedo ayudarte con nuestros servicios odontolÃ³gicos o para agendar una cita?\".\n\n[EJEMPLO PRÃCTICO]\n* **Si el usuario envÃ­a la imagen `caries.jpg` (la muela con la mancha oscura):**\n* **Tu salida DEBE ser:** \"Gracias por compartir la imagen. Para poder entender tu caso y darte la mejor soluciÃ³n, es indispensable que la Dra. Henao realice una valoraciÃ³n profesional. Â¿Te gustarÃ­a agendar una cita de diagnÃ³stico? Tiene un costo de $20,000.\"","imageUrls":"={{ $json['data url'] }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[336,368],"id":"5bb55504-ab90-4482-b89a-c20af6d9cd8a","name":"Analyze image","credentials":{"googlePalmApi":{"id":"fqAagNkEpEri1Av1","name":"Conexiones Grupo DK Soluciones"}}},{"parameters":{"promptType":"define","text":"={{ $json['mensajeusuario'] }}","options":{"systemMessage":"=[ROL Y PERSONALIDAD]\nActÃºa como \"SofÃ­a\", la asistente del consultorio odontolÃ³gico Vivadent. Eres la mano derecha de la Dra. Viviancy Henao. Tu tono de comunicaciÃ³n debe ser siempre amable, profesional y cercano. SÃ© siempre concisa y ve directo al punto.\n\n[FECHA Y HORA ACTUAL]\nHOY ES: {{ $now.setZone('America/Bogota').toFormat('cccc, d \\'de\\' MMMM \\'de\\' yyyy') }}\nZONA HORARIA DE OPERACIÃ“N: America/Bogota (UTC-5)\n\n[CONTEXTO DEL CONSULTORIO]\n* **Nombre:** Vivadent\n* **OdontÃ³loga Principal:** Dra. Viviancy Henao\n* **Telefono:** 3007208856\n* **UbicaciÃ³n:** Don MatÃ­as, Antioquia\n* **Direccion:** Edificio LAGE calle 30 n 31-6 local 01, al lado de la nueva sede de la Notaria.\n* **Costo Valoracion:** el costo de la vsloracion es de $20.000 \n* **Horarios:** Lunes a Viernes de 9:30 AM a 4:00 PM. SÃ¡bados de 9:30 AM a 2:30 PM. SI EL CLIENTE NECESITA UNA CITA FUERA DE ESTE HORARIO, dile que se puede comunicar directamente con la doctora Viviancy Henao al Telefono: 3007208856 o enviarle un mensaje por WhatsApp\n\n\n---\n[PROCESO PRINCIPAL DE LA CONVERSACIÃ“N]\nTu objetivo es responder preguntas o agendar citas. Sigue este flujo lÃ³gico:\n\n1.  **Analiza la PeticiÃ³n del Usuario:**\n    *   **Primero, busca en tu contexto:** Si la pregunta es sobre informaciÃ³n bÃ¡sica que se encuentra en la secciÃ³n [CONTEXTO DEL CONSULTORIO] (nombre, doctora, telÃ©fono, ubicaciÃ³n, direcciÃ³n, horarios), responde directamente usando esa informaciÃ³n. **NO uses una herramienta para esto.**\n    *   **Si no estÃ¡ en tu contexto:** Si la pregunta es sobre informaciÃ³n mÃ¡s especÃ­fica que NO estÃ¡ en tu contexto (como precios de tratamientos, promociones especiales, etc.), **ENTONCES Y SOLO ENTONCES** usa la herramienta `Conocimiento` para buscar la respuesta.\n    *   **Si es para agendar:** Si la solicitud es para agendar o consultar disponibilidad, ignora los pasos anteriores e inicia el [PROCESO DE AGENDAMIENTO].\n\n---\n[PROCESO DE AGENDAMIENTO]\nSigue estos pasos en orden estricto.\n\n**PASO 1: CONSULTAR DISPONIBILIDAD**\n- Cuando un usuario pida una cita, tu PRIMERA y ÃšNICA acciÃ³n es llamar a la herramienta `Disponibilidad` para verificar el horario.\n\n**PASO 2: OFRECER HORARIO Y PEDIR DATOS**\n- Si el horario estÃ¡ disponible, informa al usuario y pide sus datos: \"Â¡Perfecto! El horario de [Hora] del [Fecha] estÃ¡ disponible. Para confirmar tu cita, por favor indÃ­came tu nombre, apellido y nÃºmero de telÃ©fono.\"\n- Si estÃ¡ ocupado, ofrece la siguiente hora libre mÃ¡s cercana.\n\n**PASO 3: EJECUTAR AGENDAMIENTO (ACCIÃ“N CRÃTICA)**\n- Cuando el usuario te responda con su nombre, apellido y telÃ©fono, tu siguiente acciÃ³n OBLIGATORIA es llamar a la herramienta `Agendar`, pasÃ¡ndole la informaciÃ³n que acabas de recibir y la fecha/hora que ya habÃ­as confirmado.\n\n**PASO 4: CONFIRMACIÃ“N FINAL**\n- Una vez que la herramienta `Agendar` se ejecute con Ã©xito, responde al cliente.\n- **REGLA CRÃTICA DE RESPUESTA:** En tu mensaje de confirmaciÃ³n, DEBES usar la frase \"**estÃ¡ confirmada**\" o \"**ha sido agendada**\" para que el sistema pueda verificar el resultado.\n\nEjemplo de respuesta: \"Â¡Excelente! Tu cita para el [Fecha] a las [Hora] ha sido agendada con Ã©xito.\"\n\n---\n[REGLA CRÃTICA DE CONTEXTO Y AGENDAMIENTO FINAL]\nCuando el usuario responda con una hora, su nombre y su telÃ©fono, despuÃ©s de que tÃº le hayas ofrecido disponibilidad, debes seguir estos pasos:\n\n1.  **Recordar la Fecha:** NO olvides la fecha del dÃ­a que ofreciste en tu mensaje anterior. Es tu responsabilidad combinar esa fecha con la nueva hora que te dio el cliente.\n2.  **Analizar los Datos del Cliente:**\n    *   El primer dato numÃ©rico de 10 dÃ­gitos es el `numeroTelefono`.\n    *   Para nombres compuestos, considera la primera palabra como el `nombre` y el resto como el `apellido`. (Ej: \"Jose Luis Cuesta\" -> nombre: \"Jose\", apellido: \"Luis Cuesta\").\n3.  **Construir la Hora UTC:** Combina la fecha que recordaste con la hora que te dieron, y convierte el resultado a UTC (sumando 5 horas).\n4.  **Llamar a la Herramienta:** Con todos los datos listos, tu Ãºnica acciÃ³n es llamar a la herramienta `Agendar`.\n\n[HERRAMIENTAS DISPONIBLES]\n\n1.  **Herramienta: `Conocimiento`**\n    *   **PropÃ³sito:** Responde preguntas sobre servicios, precios y promociones.\n\n2.  **Herramienta: `Disponibilidad`**\n    *   **PropÃ³sito:** Verifica la disponibilidad del calendario.\n    *   **Regla de conversiÃ³n:** Para usarla, convierte la hora de Colombia a UTC (sumando 5 horas).\n\n3.  **Herramienta: `Agendar`**\n    *   **PropÃ³sito:** Crea la cita final en el calendario de Google.\n    *   **Regla de uso:** LlÃ¡mala Ãºnicamente en el PASO 3 del [PROCESO DE AGENDAMIENTO].\n    *   **ParÃ¡metros Requeridos:** Esta herramienta necesita que le proporciones los siguientes valores:\n        - `fechaHoraConfirmadaUTC` (string)\n        - `nombre` (string)\n        - `apellido` (string)\n        - `numeroTelefono` (string)"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1104,208],"id":"3d7085a6-2c96-429b-8113-53ce34b819fc","name":"Agente Vivadent"},{"parameters":{"descriptionType":"manual","toolDescription":"Ãšsala para responder CUALQUIER pregunta general del usuario sobre la clÃ­nica, como servicios, precios, horarios, promociones o la experiencia de la doctora, tamnien servicios especiales y suero terapia.","useCustomSchema":true,"schema":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Schema', `{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"Una o dos palabras clave que resuman la pregunta del usuario. Ejemplo: si el usuario pregunta 'Â¿QuÃ© servicios ofrecen?', el query deberÃ­a ser 'servicios'. Si pregunta por el precio, 'precio'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}`, 'string') }}","operation":"getAll","tableId":"=odontologia_vivadent","filters":{"conditions":[{"keyName":"=pregunta_clave","condition":"ilike","keyValue":"=%{{ $json.query }}%"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[1104,464],"id":"94acedea-b37b-4166-bc7a-0151bef2f69b","name":"Conocimiento","credentials":{"supabaseApi":{"id":"TbX6FhcgL4LeOMan","name":"Supabase Grupo DK"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"18fbfc9d-90d3-4562-a31f-7049f0cab39d","leftValue":"={{ $json.output }}","rightValue":"estÃ¡ confirmada","operator":{"type":"string","operation":"contains"}},{"id":"faa95ca0-df53-4f6c-9d08-6bdb23e079a1","leftValue":"={{ $json.output }}","rightValue":"agendada ","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1488,208],"id":"c3eac51c-5648-4b11-8c7b-922317ee7d58","name":"Valida datos del cliente"},{"parameters":{"jsCode":"// --- Paso 1: Obtener el texto de confirmaciÃ³n y los datos del nodo inicial ---\n\n// Texto de confirmaciÃ³n del agente (nuestro input directo)\nconst textoConfirmacion = items[0].json.output;\n\n// Nodo \"Recibe Mensaje\" para obtener el NÃšMERO ESTRUCTURADO\n// Â¡VERIFICA QUE EL NOMBRE \"Recibe Mensaje\" SEA EXACTAMENTE IGUAL!\nconst recibeMensajeNode = $('Recibe Mensaje');\n\n\n// --- Paso 2: Inicializamos las variables ---\nlet fecha = \"no encontrada\";\nlet hora = \"no encontrada\";\nlet nombre = \"no especificado\";\nlet apellido = \"no especificado\";\nlet telefono = \"no encontrado\";\nlet correo = \"no tiene correo\";\n\n\n// --- Paso 3: Extraer datos del texto de confirmaciÃ³n del Agente ---\n\n// Extraer fecha\nconst fechaMatch = textoConfirmacion.match(/para el (\\d+ de \\w+)/i);\nif (fechaMatch && fechaMatch[1]) {\n  fecha = fechaMatch[1];\n}\n\n// Extraer hora\nconst horaMatch = textoConfirmacion.match(/a las (\\d{1,2}:\\d{2} (?:AM|PM))/i);\nif (horaMatch && horaMatch[1]) {\n  hora = horaMatch[1];\n}\n\n// Extraer nombre completo\nconst nombreMatch = textoConfirmacion.match(/a nombre de ([\\wÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ±Ã‘\\s]+)\\./i);\nif (nombreMatch && nombreMatch[1]) {\n  const nombreCompleto = nombreMatch[1].trim().split(' ');\n  nombre = nombreCompleto[0];\n  if (nombreCompleto.length > 1) {\n    apellido = nombreCompleto.slice(1).join(' ');\n  }\n}\n\n// --- Paso 4: Extraer el telÃ©fono del CAMPO ESTRUCTURADO ---\nif (recibeMensajeNode && recibeMensajeNode.item && recibeMensajeNode.item.json && recibeMensajeNode.item.json.numero) {\n  telefono = recibeMensajeNode.item.json.numero;\n}\n\n\n// --- Paso 5: Devolvemos el objeto JSON con todos los datos recopilados ---\nreturn [{\n  json: {\n    fecha: fecha,\n    hora: hora,\n    nombre: nombre,\n    apellido: apellido,\n    correo: correo,\n    telefono: telefono\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1904,-16],"id":"3beab277-f00b-431f-ad84-66da89deaa01","name":"Datos del Cliente"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1osFCESvqnLLpkqfYbsZKed8DtNsM937v12UloIbTsIA","mode":"list","cachedResultName":"Control Citas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1osFCESvqnLLpkqfYbsZKed8DtNsM937v12UloIbTsIA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Citas Valoracion","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1osFCESvqnLLpkqfYbsZKed8DtNsM937v12UloIbTsIA/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Fecha":"={{ $json.fecha }}","Hora":"={{ $json.hora }}","Nombre":"={{ $json.nombre }}","Apellido":"={{ $json.apellido }}","Correo":"={{ $json.correo }}","Telefono":"={{ $json.telefono }}"},"matchingColumns":[],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Hora","displayName":"Hora","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Apellido","displayName":"Apellido","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Correo","displayName":"Correo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Observaciones","displayName":"Observaciones","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2144,-16],"id":"d50e8e44-b241-4c57-a7fc-dba5b26c5e1e","name":"Control de citas","credentials":{"googleSheetsOAuth2Api":{"id":"r9WNQMfasZfbEzbO","name":"Google Sheets Vivadent"}}},{"parameters":{"method":"POST","url":"=https://crm.vivadentodontologia.online/api/v1/accounts/{{ $('Recibe Mensaje').item.json['cuenta id'] }}/conversations/{{ $('Recibe Mensaje').item.json['conversacion id'] }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"=api_access_token","value":"=UPCzavt6Mfq7V855uGbmKDYe"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $('Valida datos del cliente').item.json.output }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2416,-16],"id":"06c885e6-27cb-4712-ad67-441ca9589739","name":"Envia Cita Confirmada"},{"parameters":{"method":"POST","url":"=https://crm.vivadentodontologia.online/api/v1/accounts/{{ $('Recibe Mensaje').item.json['cuenta id'] }}/conversations/{{ $('Recibe Mensaje').item.json['conversacion id'] }}/assignments","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"UPCzavt6Mfq7V855uGbmKDYe"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"=assignee_id","value":"2"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2688,-16],"id":"2e19ec57-0e67-4284-9e40-91800b919662","name":"Asigna Agente"},{"parameters":{"method":"POST","url":"=https://crm.vivadentodontologia.online/api/v1/accounts/{{ $('Recibe Mensaje').item.json['cuenta id'] }}/conversations/{{ $('Recibe Mensaje').item.json['conversacion id'] }}/toggle_status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"UPCzavt6Mfq7V855uGbmKDYe"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"=status","value":"open"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2928,-16],"id":"a2703a7f-3d7a-4e88-99c0-0e0598da0d29","name":"Cambia Estado"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[736,448],"id":"ab2b9ac2-e034-4698-a8da-3b7a9ecd61df","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"fqAagNkEpEri1Av1","name":"Conexiones Grupo DK Soluciones"}}},{"parameters":{"toolDescription":"Utiliza esta herramienta para VERIFICAR si la fecha y hora especÃ­ficas que un cliente solicita estÃ¡n disponibles. Cuando un cliente te dÃ© un dÃ­a y una hora, debes activar esta herramienta. La herramienta te devolverÃ¡ una lista de TODOS los espacios disponibles. Tu tarea es:\n\n1.  **Revisar:** Busca si la hora que el cliente pidiÃ³ estÃ¡ en la lista que recibiste.\n2.  **Si estÃ¡ disponible:** Responde al cliente confirmando que esa hora estÃ¡ libre y procede con el agendamiento.\n3.  **Si NO estÃ¡ disponible:** Informa al cliente que ese horario ya estÃ¡ ocupado y ofrÃ©cele las 2 o 3 alternativas mÃ¡s cercanas de la lista que recibiste.","url":"https://api.cal.com/v2/slots","sendQuery":true,"queryParameters":{"parameters":[{"name":"eventTypeSlug","value":"30min"},{"name":"start","value":"={{ $now.toUTC().toISO() }}"},{"name":"end","value":"={{ $now.plus({ days: 7 }).toUTC().toISO() }}"},{"name":"username","value":"andrea-henao-ezjzwm"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer cal_live_e86fecc7949303abb23acfd54a347520"},{"name":"cal-api-version","value":"2024-09-04"}]},"options":{}},"type":"n8n-nodes-base.httpRequestTool","typeVersion":4.2,"position":[1472,448],"id":"2c992991-7f3b-4900-9b8b-0b346b15396c","name":"Disponibilidad"},{"parameters":{"calendar":{"__rl":true,"value":"odontologaviviancyhenao@gmail.com","mode":"list","cachedResultName":"odontologaviviancyhenao@gmail.com"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}","end":"={{ DateTime.fromISO($json.Start).plus({ minutes: 30 }).toISO() }}","additionalFields":{"attendees":[],"summary":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', ``, 'string') }}"}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[1264,464],"id":"26d0589d-d002-4174-8964-5e2008c9c1d5","name":"Agendar","credentials":{"googleCalendarOAuth2Api":{"id":"AXibNNcm83HZ9XPv","name":"Google Calendar Vivadent"}}}],"connections":{"Webhook -CRM Vivadent":{"main":[[{"node":"Valida ID Conversacion","type":"main","index":0}]]},"Valida ID Conversacion":{"main":[[{"node":"Mapea Mensaje Usuario","type":"main","index":0}]]},"Mapea Mensaje Usuario":{"main":[[{"node":"Tipo Mensaje","type":"main","index":0}]]},"Tipo Mensaje":{"main":[[{"node":"Transcribe Audio","type":"main","index":0}],[{"node":"Recolecta Datos","type":"main","index":0}],[{"node":"Analyze image","type":"main","index":0}]]},"Recibe Mensaje":{"main":[[{"node":"Agente Vivadent","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Agente Vivadent","type":"ai_memory","index":0}]]},"Transcribe Audio":{"main":[[{"node":"Recolecta Datos","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"Recolecta Datos","type":"main","index":0}]]},"Recolecta Datos":{"main":[[{"node":"Recibe Mensaje","type":"main","index":0}]]},"Agente Vivadent":{"main":[[{"node":"Valida datos del cliente","type":"main","index":0}]]},"Conocimiento":{"ai_tool":[[{"node":"Agente Vivadent","type":"ai_tool","index":0}]]},"Envia Mensaje":{"main":[[]]},"Valida datos del cliente":{"main":[[{"node":"Datos del Cliente","type":"main","index":0}],[{"node":"Envia Mensaje","type":"main","index":0}]]},"Datos del Cliente":{"main":[[{"node":"Control de citas","type":"main","index":0}]]},"Control de citas":{"main":[[{"node":"Envia Cita Confirmada","type":"main","index":0}]]},"Envia Cita Confirmada":{"main":[[{"node":"Asigna Agente","type":"main","index":0}]]},"Asigna Agente":{"main":[[{"node":"Cambia Estado","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"Agente Vivadent","type":"ai_languageModel","index":0}]]},"Disponibilidad":{"ai_tool":[[{"node":"Agente Vivadent","type":"ai_tool","index":0}]]},"Agendar":{"ai_tool":[[{"node":"Agente Vivadent","type":"ai_tool","index":0}]]}},"settings":{"timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner","executionOrder":"v0"},"staticData":null,"meta":{"templateId":"3131","templateCredsSetupCompleted":true},"pinData":{"Webhook -CRM Vivadent":[{"json":{"headers":{"connection":"Upgrade","host":"n8.enterprisetecno.com","x-real-ip":"212.56.33.215","x-forwarded-for":"212.56.33.215","x-forwarded-proto":"https","content-length":"1847","accept":"application/json","user-agent":"rest-client/2.1.0 (linux x86_64) ruby/3.4.4p34","content-type":"application/json","accept-encoding":"gzip;q=1.0,deflate;q=0.6,identity;q=0.3"},"params":{},"query":{},"body":{"additional_attributes":{},"can_reply":true,"channel":"Channel::Whatsapp","contact_inbox":{"id":78,"contact_id":76,"inbox_id":5,"source_id":"573208457909","created_at":"2025-10-25T21:50:23.867Z","updated_at":"2025-10-25T21:50:23.867Z","hmac_verified":false,"pubsub_token":"hsrpvxRxU3RxVxDNCbcmf9UR"},"id":84,"inbox_id":5,"messages":[{"id":750,"content":"Pero no sÃ© dÃ³nde estÃ¡n obii","account_id":1,"inbox_id":5,"conversation_id":84,"message_type":0,"created_at":1761429043,"updated_at":"2025-10-25T21:50:43.024Z","private":false,"status":"sent","source_id":"wamid.HBgMNTczMjA4NDU3OTA5FQIAEhggQUNDNUVBMDRBMzgyQ0VEQTNCREU2QUMxRThCMkQyMDkA","content_type":"text","content_attributes":{},"sender_type":"Contact","sender_id":76,"external_source_ids":{},"additional_attributes":{},"processed_message_content":"Pero no sÃ© dÃ³nde estÃ¡n obii","sentiment":{},"conversation":{"assignee_id":null,"unread_count":2,"last_activity_at":1761429043,"contact_inbox":{"source_id":"573208457909"}},"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":76,"identifier":null,"name":"â˜•â˜•â˜•ðŸ˜˜ðŸ˜˜ðŸ˜˜","phone_number":"+573208457909","thumbnail":"","blocked":false,"type":"contact"}}],"labels":[],"meta":{"sender":{"additional_attributes":{},"custom_attributes":{},"email":null,"id":76,"identifier":null,"name":"â˜•â˜•â˜•ðŸ˜˜ðŸ˜˜ðŸ˜˜","phone_number":"+573208457909","thumbnail":"","blocked":false,"type":"contact"},"assignee":null,"team":null,"hmac_verified":false},"status":"open","custom_attributes":{},"snoozed_until":null,"unread_count":2,"first_reply_created_at":"2025-10-25T21:50:28.674Z","priority":null,"waiting_since":1761429043,"agent_last_seen_at":0,"contact_last_seen_at":0,"last_activity_at":1761429043,"timestamp":1761429043,"created_at":1761429024,"updated_at":1761429043.851935,"event":"automation_event.message_created"},"webhookUrl":"https://n8.enterprisetecno.com/webhook/vivadent_odontologia","executionMode":"production"}}]},"versionId":"ad5a7895-b4f2-4fe1-bf80-8801f867c429","triggerCount":1,"shared":[{"createdAt":"2025-09-29T11:48:09.383Z","updatedAt":"2025-09-29T11:48:09.383Z","role":"workflow:owner","workflowId":"kcusjclmkEm6reQJ","projectId":"B3H8EZwaIhSfaZKt"}],"tags":[]}