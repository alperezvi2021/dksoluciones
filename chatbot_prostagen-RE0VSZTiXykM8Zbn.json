{"createdAt":"2025-07-16T20:04:26.655Z","updatedAt":"2025-08-06T21:00:21.000Z","id":"RE0VSZTiXykM8Zbn","name":"Chatbot_prostagen","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"cf693b5c-706a-4001-b5d8-6b64bc47e135","options":{}},"name":"Webhook -- Wasapi","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-2360,240],"id":"22cad3f8-5c2b-4490-815b-9af04468a1ba","webhookId":"cf693b5c-706a-4001-b5d8-6b64bc47e135"},{"parameters":{"resource":"audio","operation":"transcribe","options":{"language":"es"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-1280,80],"id":"bbb4f0c3-754b-4207-a5e7-e78d4fbdd2ca","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"334eb726-7674-4f91-beb1-16da6d8d0eb3","leftValue":"={{ $json.type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.type }}","rightValue":"text","operator":{"type":"string","operation":"equals"},"id":"b055bc2e-a7e7-402f-a616-6c42b02dd4a1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1660,220],"id":"e77a78df-bd31-41c9-8d98-a7e439bd3418","name":"Tipo de Mensaje"},{"parameters":{"assignments":{"assignments":[{"id":"3b47ea5a-a76c-4160-a88d-d685658c200d","name":"body","value":"={{ $json.body }}","type":"string"},{"id":"d550409f-9300-49ab-b18b-63ce3629a4bc","name":"type","value":"={{ $json.body.data.message_type }}","type":"string"},{"id":"27d2c7af-747b-4849-925b-08246cb276db","name":"message","value":"={{ $json.body.data.message }}","type":"string"},{"id":"61b336dd-b2b2-4332-904e-1a8b68157a24","name":"number","value":"={{ $json.body.data.wa_id }}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1860,220],"id":"71c8ca56-4767-4d1f-8230-b44a4740e3f1","name":"Mapea el Mensaje Usuario"},{"parameters":{"values":{"string":[{"name":"number","value":"={{ $('Mapea el Mensaje Usuario').item.json.number }}  "},{"name":"mensaje_usuario","value":"={{ $json.message }}{{ $json.text }}"}]},"options":{}},"name":"Recibe Mensaje","type":"n8n-nodes-base.set","typeVersion":2,"position":[-1100,240],"id":"9c82f537-4149-4a5c-80b5-43a7bd871daa"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{"temperature":0.1}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-920,520],"id":"bafc00d1-e7c3-4cd1-b0c0-472671c73311","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"modelId":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"GPT-4.1-MINI"},"messages":{"values":[{"content":"={{ $json.output }}"},{"content":"En base a la respuesta recibida, determina si la respuesta deberÃ­amos dÃ¡rsela en formato audio o formato texto.\n\nTrata de enviar el 0% de las veces un audio y 100% texto. resÃ©rvate el texto para cuando te pida en el mensaje explÃ­citamente que le envÃ­es un texto y para cuando en el mensaje se detalle mucha informaciÃ³n sobre el programa, los mÃ³dulos, etc... y supere la capacidad de tamaÃ±o permitida por la plataforma que es de 2MB\n\nSimplemente responde: \"Audio\" o \"Texto\"","role":"system"}]},"options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-180,260],"id":"5158f5ae-e583-4e26-a297-1233d4c0591e","name":"Tipo de Respuesta","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.message.content }}","rightValue":"Texto","operator":{"type":"string","operation":"equals"},"id":"0f070bd9-c076-4298-bfd4-8f81f87a4494"}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c5f99960-651b-443a-87ff-54d6232af484","leftValue":"={{ $json.message.content }}","rightValue":"Audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Audio"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[180,260],"id":"f65f5889-9a8a-4314-a9a7-ce6ff7bbbfe1","name":"Selecciona Respuesta"},{"parameters":{"url":"={{$json[\"message\"]}}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1460,80],"id":"5ff907bf-59a4-42ac-905f-8fc16fde975c","name":"Captura Audio","alwaysOutputData":false},{"parameters":{"operation":"write","fileName":"=/files/audios/audio.mp3","options":{}},"type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[820,500],"id":"51cc063d-1e27-477b-82fb-83d2d18741d8","name":"Descargar Audio"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/attachment","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"file","value":"audio_url"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"audio_url","value":"={{ $json.stdout }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1280,500],"id":"b4bc0e8f-aee3-41df-ba42-c31d1837049d","name":"Envia Mensajes Audio"},{"parameters":{"method":"POST","url":" https://api-ws.wasapi.io/api/v1/whatsapp-messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Agente Camila').item.json.output }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[620,0],"id":"a34f130f-7ba5-48c7-b425-1f2a29068676","name":"Envia Mensaje Texto"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c6f97ebd-22b9-43a2-8611-23883d460893","leftValue":"={{ $json.data.message }}","rightValue":"Un agente de servicio al cliente","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[820,0],"id":"e6adeeaf-5ca0-4812-9c7d-d08dd81cf4c5","name":"Verifica si estan los Datos"},{"parameters":{"jsCode":"const mensaje = $json.data.message;\n\nconst datos = {\n  fecha: new Date().toLocaleDateString('es-CO'),\n  \n  // Extraer nombre usando mÃºltiples patrones\n  nombre: mensaje.match(/\\*\\*Cliente\\*\\*:\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n          mensaje.match(/Nombre[:\\s]*(.+?)(?:\\n|,|\\.|$)/i)?.[1]?.trim() || \n          mensaje.match(/me llamo\\s+([^,\\n]+)/i)?.[1]?.trim() || \"\",\n  \n  // Extraer ciudad y departamento\n  ciudad: mensaje.match(/\\*\\*Ciudad\\*\\*:\\s*(.+?)(?:,|\\n|\\*\\*|$)/i)?.[1]?.trim() || \n          mensaje.match(/Ciudad[:\\s]*(.+?)(?:,|\\n|$)/i)?.[1]?.trim() || \n          mensaje.match(/soy de\\s+([^,\\n]+)/i)?.[1]?.trim() || \"\",\n  \n  departamento: mensaje.match(/\\*\\*Ciudad\\*\\*:\\s*[^,]+,\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n                mensaje.match(/Departamento[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \"\",\n  \n  // Extraer direcciÃ³n completa\n  direccion: mensaje.match(/\\*\\*DirecciÃ³n\\*\\*:\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n             mensaje.match(/DirecciÃ³n[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n             mensaje.match(/(?:vivo en|mi direcciÃ³n es)\\s*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \"\",\n  \n  // Extraer telÃ©fono\n  telefono: mensaje.match(/\\*\\*TelÃ©fono\\*\\*:\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n            mensaje.match(/TelÃ©fono[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n            mensaje.match(/(?:mi telÃ©fono|mi nÃºmero).*?(\\d{10})/i)?.[1] || \n            mensaje.match(/(\\d{3}[-\\s]?\\d{3}[-\\s]?\\d{4})/)?.[1] || \"\",\n  \n  // Extraer cantidad\n  cantidad: mensaje.match(/\\*\\*Cantidad\\*\\*:\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n            mensaje.match(/Cantidad[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n            mensaje.match(/quiero\\s+(\\d+)/i)?.[1] || \"1\",\n  \n  // Extraer presentaciÃ³n del producto\n  presentacion: mensaje.match(/\\*\\*Producto\\*\\*:\\s*Prostagen\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n                mensaje.match(/PresentaciÃ³n[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n                mensaje.match(/(\\d+\\s*litros?)/i)?.[1] || \n                mensaje.match(/(1L|2L)/i)?.[1] || \"\",\n  \n  // Extraer valor/precio\n  valor: mensaje.match(/\\*\\*Valor\\*\\*:\\s*\\$?(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n         mensaje.match(/Precio[:\\s]*\\$?(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n         mensaje.match(/\\$(\\d{1,3}(?:,\\d{3})*(?:\\.\\d{2})?)/)?.[1] || \"\",\n  \n  // Extraer mÃ©todo de pago\n  metodo_pago: mensaje.match(/\\*\\*MÃ©todo de pago\\*\\*:\\s*(.+?)(?:\\n|\\*\\*|$)/i)?.[1]?.trim() || \n               mensaje.match(/pago[:\\s]*(.+?)(?:\\n|,|$)/i)?.[1]?.trim() || \n               (mensaje.includes(\"contra entrega\") ? \"Contra entrega\" : \n                mensaje.includes(\"consignaciÃ³n\") ? \"ConsignaciÃ³n\" : \"\"),\n  \n  // Datos adicionales del contexto\n  mensaje_completo: mensaje,\n  timestamp: new Date().toISOString(),\n  \n  // Validaciones\n  datos_completos: function() {\n    return this.nombre && this.ciudad && this.direccion && this.telefono;\n  }\n};\n\n// Limpiar datos vacÃ­os y espacios extra\nObject.keys(datos).forEach(key => {\n  if (typeof datos[key] === 'string') {\n    datos[key] = datos[key].replace(/\\s+/g, ' ').trim();\n  }\n});\n\n// Validar si la direcciÃ³n estÃ¡ completa (debe tener calle/carrera)\nconst direccionCompleta = datos.direccion && \n  (datos.direccion.match(/(?:calle|carrera|cr|cl|avenida|av|diagonal|transversal)/i) ||\n   datos.direccion.match(/\\d+.*#.*\\d+/));\n\ndatos.direccion_valida = direccionCompleta;\n\nreturn {\n  json: datos\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1080,-20],"id":"48f47399-c642-4cfd-9cb7-dfa05bdc0ae2","name":"Extrae los Datos del Pedido"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1qw_GCPYEsfw8KgL9UkhJf55tNrOsUEsZccrrV7B1Atw","mode":"list","cachedResultName":"Prostagen ","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1qw_GCPYEsfw8KgL9UkhJf55tNrOsUEsZccrrV7B1Atw/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":495724026,"mode":"list","cachedResultName":"Pedidos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1qw_GCPYEsfw8KgL9UkhJf55tNrOsUEsZccrrV7B1Atw/edit#gid=495724026"},"columns":{"mappingMode":"defineBelow","value":{"Fecha":"={{ $json.fecha }}","Nombre":"={{ $json.nombre }}","Telefono":"={{ $json.telefono }}","Cantidad ":"={{ $json.cantidad }}","Presentacion ":"={{ $json.presentacion }}","Direccion ":"={{ $json.direccion }}","Ciudad":"={{ $json.ciudad }}","Departamento":"={{ $json.departamento }}"},"matchingColumns":[],"schema":[{"id":"Fecha","displayName":"Fecha","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Nombre","displayName":"Nombre","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Telefono","displayName":"Telefono","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Direccion ","displayName":"Direccion ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Ciudad","displayName":"Ciudad","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Departamento","displayName":"Departamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Cantidad ","displayName":"Cantidad ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Presentacion ","displayName":"Presentacion ","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Seguimiento cliente","displayName":"Seguimiento cliente","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[1300,-20],"id":"a75a16f9-5026-4167-b816-283a92f3800e","name":"Agrega Pedido Nuevo Hoja de Excel","credentials":{"googleSheetsOAuth2Api":{"id":"jYDBpVufkahSrbzO","name":"Google Sheets Prostagen"}}},{"parameters":{"jsCode":"// Obtener el nÃºmero desde el nodo \"Mapea el Mensaje Usuario\"\nlet numeroOriginal = $('Mapea el Mensaje Usuario').first().json.number || '';\n\n// Convertir a string si no lo es\nif (typeof numeroOriginal !== 'string') {\nnumeroOriginal = String(numeroOriginal);\n}\n\n// Limpiar el nÃºmero de caracteres no numÃ©ricos\nconst numero = numeroOriginal.replace(/\\D/g, '');\n\n// Lista de contactos recibida desde el nodo \"Get many contacts\"\nconst contactos = items;\n\nlet existe = false;\n\nfor (const contacto of contactos) {\nconst telefonos = contacto.json.phoneNumbers?.mobile || [];\nfor (const tel of telefonos) {\nconst telLimpio = String(tel).replace(/\\D/g, '');\nif (telLimpio === numero) {\nexiste = true;\nbreak;\n}\n}\nif (existe) break;\n}\n// Devolver resultado para el nodo IF\nreturn [{ json: { existe } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1940,-20],"id":"68b51bd3-1684-449b-8dad-c604f28ecfad","name":"Resultado de la Busquedad"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"01bb1256-606c-4108-ab62-19d62cb2086c","leftValue":"={{ $json.existe }}","rightValue":"false","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2140,-20],"id":"b434e93f-5c92-4587-8c29-82f768cbdfc3","name":"Verifica si el Contacto Existe"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/change-status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"status","value":"open"},{"name":"validate_assigned_status","value":"1"},{"name":"agent_id","value":"=36825"},{"name":"assignToAgentId","value":"36825"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1520,-20],"id":"74eea37e-600e-4032-bd9b-7d93773e372c","name":"Cambia Estado Conversacion"},{"parameters":{"resource":"audio","input":"={{ $('Agente Camila').item.json.output }}","voice":"shimmer","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[600,500],"id":"578bc55b-ac48-46f3-a488-2cb3d3bdf9de","name":"Genera el audio","credentials":{"openAiApi":{"id":"Rxw5N0sHWZ5keb1k","name":"OpenAi account"}}},{"parameters":{"command":"sh /files/audios/renombrar_audio.sh"},"type":"n8n-nodes-base.executeCommand","typeVersion":1,"position":[1040,500],"id":"127f5131-9889-44c6-a5a5-a5718211ee7a","name":"Renombra Archivo Audio"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-920,240],"id":"5bcd5631-bc01-498b-a3a5-c8691aac576c","name":"Timer para enviar mensaje","webhookId":"bbe7dd67-4d20-4821-9b5a-63ab4258ba47"},{"parameters":{"operation":"getAll","returnAll":true,"fields":["phoneNumbers","names"],"options":{}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[1720,-20],"id":"874010af-6307-4875-8ea9-73f34f8cc101","name":"Busca el Contacto","alwaysOutputData":true,"credentials":{"googleContactsOAuth2Api":{"id":"uV9tgeco0YQSxoVN","name":"Google Contacts Prostagen"}}},{"parameters":{"jsCode":"// Obtener datos desde los nodos anteriores\nconst nombre = $node[\"Extrae los Datos del Pedido\"].json.nombre;\nconst celular = $node[\"Mapea el Mensaje Usuario\"].json.number;\n\nreturn [\n  {\n    json: {\n      nombre,\n      celular\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2400,-40],"id":"876a9c1e-79c2-4a6b-be5c-5bd5e63c0656","name":"Datos Contacto"},{"parameters":{"familyName":"=","givenName":"={{ $json.nombre }}","additionalFields":{"phoneUi":{"phoneValues":[{"type":"mobile","value":"=+{{ $json.celular }}"}]}}},"type":"n8n-nodes-base.googleContacts","typeVersion":1,"position":[2640,-40],"id":"f7b49be2-2276-4fd7-8b95-5205abb7c0ff","name":"Crear un Contacto","credentials":{"googleContactsOAuth2Api":{"id":"uV9tgeco0YQSxoVN","name":"Google Contacts Prostagen"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"75cc19e7-a633-4a11-8899-df43c9399c26","leftValue":"={{ $json.body.data.chat_status.conversation_status }}","rightValue":"open","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2100,240],"id":"f5b10ba4-71e0-4d21-86e9-c53fae5d24c6","name":"Comprueba Estado de la ConversaciÃ³n"},{"parameters":{"promptType":"define","text":"={{ $json.mensaje_usuario }}","options":{"systemMessage":"Eres Camila, una experta en salud masculina que vende Prostagen. limita tus respuestas y atencion solo a este producto.\n\n## IDENTIDAD Y TONO\n- **Nombre**: Camila\n- **Rol**: Experta en salud masculina especializada en Prostagen\n- **Tono**: EmpÃ¡tico, profesional y cercano\n- **Uso de emojis**: EstratÃ©gico para captar atenciÃ³n sin saturar\n- **Principio clave**: Una pregunta por respuesta para no abrumar\n\n## FLUJO DE CONVERSACIÃ“N\n\n### 1. APERTURA E IDENTIFICACIÃ“N DE SÃNTOMAS\nNo saludes, continua con la conversaciÃ³n.\n\n### 2. EMPATÃA Y PRESENTACIÃ“N DEL PRODUCTO\nUna vez identificado el problema:\n- Valida el dolor/molestia del cliente\n- Conecta especÃ­ficamente con su sÃ­ntoma\n- Presenta Prostagen como soluciÃ³n dirigida\n- Pregunta por la ciudad para el envÃ­o\n\n**Ejemplo**: *\"Entiendo perfectamente lo molesto que debe ser [sÃ­ntoma especÃ­fico]. Prostagen ha ayudado a cientos de hombres con exactamente tu misma situaciÃ³n...\"*\n\n### 3. PRESENTACIÃ“N DE PRECIOS Y CIERRE\nDespuÃ©s de conocer la ciudad:\n- Presenta opciones de precio\n- Explica mÃ©todos de pago segÃºn ubicaciÃ³n\n- Hace preguntas persuasivas\n- Garantiza resultados desde la primera semana\n\n### 4. TOMA DE PEDIDO\nSi el cliente decide comprar, solicita datos en este orden:\n1. âœ… **Nombre completo**\n2. âœ… **Ciudad**\n3. âœ… **Departamento**\n4. âœ… **DirecciÃ³n completa** (calle/carrera + nÃºmero + detalles)\n5. âœ… **TelÃ©fono**\n6. âœ… **Cantidad deseada**\n7. âœ… **PresentaciÃ³n** (1L o 2L)\n\n**Nota crÃ­tica**: Sin direcciÃ³n completa NO se procesa el pedido.\n\n**Nota Importante**: Cuando el cliente menciona que desea ver testimonios, debes decirle que ya le vas a mostrar que dicen nuestros clientes sobre el producto y activa el marcador [[ENVIAR_TESTIMONIOS]] al final de tu mensaje.\n\n### 5. PROCESAMIENTO DE DATOS Y FINALIZACIÃ“N\n\n**IMPORTANTE**: Ve agregando la informaciÃ³n a medida que el cliente la proporciona para completar el pedido. Una vez el cliente envÃ­e sus datos completos y estÃ©n correctos, NO solicites confirmaciÃ³n adicional.\n\n**Proceso de finalizaciÃ³n**:\n- Una vez recibidos todos los datos necesarios, agradece directamente por la compra\n- Informa que verificarÃ¡n la informaciÃ³n y mÃ©todo de pago\n- Explica que un agente se contactarÃ¡ pronto\n- EnvÃ­a inmediatamente el resumen completo del pedido\n\n### 6. MENSAJE DE FINALIZACIÃ“N\n*\"Â¡Muchas gracias por tu compra! ðŸ™ Vamos a verificar la informaciÃ³n de tu pedido y el mÃ©todo de pago. Un agente de servicio al cliente se pondrÃ¡ en contacto contigo pronto. Por favor, mantente pendiente del telÃ©fono ya que un asesor te llamarÃ¡ en las prÃ³ximas horas. ðŸ“ž\"*\n\n**RESUMEN DEL PEDIDO**:\n- **Cliente**: [Nombre completo]  \n- **Ciudad**: [Ciudad, Departamento]\n- **DirecciÃ³n**: [DirecciÃ³n completa]\n- **TelÃ©fono**: [NÃºmero de contacto]\n- **Producto**: Prostagen [PresentaciÃ³n]\n- **Cantidad**: [NÃºmero de unidades]\n- **Valor**: $[Precio total]\n- **MÃ©todo de pago**: [Contra entrega/ConsignaciÃ³n segÃºn ciudad]\n\n## INFORMACIÃ“N DEL PRODUCTO\n\n### PROSTAGEN - Suplemento Natural\n- **ComposiciÃ³n**: SÃ¡bila, cÃºrcuma y limÃ³n (100% natural)\n- **FunciÃ³n**: SÃ¡bila y cÃºrcuma desinflamann, limÃ³n es antioxidante\n\n### BENEFICIOS ESPECÃFICOS\nâœ… Desinflama la prÃ³stata\nâœ… Limpia los riÃ±ones  \nâœ… Drena y dilata la uretra\nâœ… Mejora la micciÃ³n\nâœ… Resultados visibles desde el 3er dÃ­a\n\n### MODO DE USO\n- ðŸŒ… Medio vaso en ayunas  \n- ðŸŒ™ Medio vaso antes de dormir\n- â„ï¸ Mantener refrigerado (NO congelar)\n\n### CONTRAINDICACIONES\nâš ï¸ **NO recomendado para**:\n- Personas con gastritis o gastritis severa\n- **Durante el tratamiento**: Evitar alcohol completamente\n\n### PRECIOS Y PRESENTACIONES\n- **1 litro**: $93.500 (tratamiento bÃ¡sico)\n- **2 litros**: $187.000 â­ **(RECOMENDADO)**\n- Precios con promociÃ³n incluida\n- NO disponible pago en cuotas\n\n### MÃ‰TODOS DE PAGO\n**MedellÃ­n y Ã¡rea metropolitana**: Pago contra entrega\n**Otras ciudades**: Pago anticipado\n- ConsignaciÃ³n: Cuenta ahorros 00123760336 Bancolombia\n- Enviar comprobante por WhatsApp\n\n### TIEMPOS DE ENTREGA\n- **MedellÃ­n/Ã¡rea metropolitana**: Mismo dÃ­a\n- **Ciudades capitales**: 2-4 dÃ­as\n- **Municipios**: 5 dÃ­as hÃ¡biles\n- **Oficinas Inter/Servientrega**: Disponible (no requiere direcciÃ³n)\n\n## MANEJO DE OBJECIONES\n\n### Registro INVIMA\n*\"No lo necesita como suplemento natural\"*\n\n### SatisfacciÃ³n del producto\n*\"Te recomiendo esperar los resultados completos. Es producto original respaldado por expertos. Cada organismo responde diferente.\"*\n**Nota**: NO ofrecemos devoluciÃ³n (mencionar solo si preguntan)\n\n## PRINCIPIOS DE VENTA\n1. **Escucha activa**: Identifica el dolor especÃ­fico\n2. **SoluciÃ³n personalizada**: Conecta beneficios con sÃ­ntomas  \n3. **Urgencia sutil**: Resultados desde primera semana\n4. **Confianza**: Producto natural y respaldado\n5. **Seguimiento**: Proceso claro post-venta\n\n## RECORDATORIOS CLAVE\n- âœ… Una pregunta por respuesta\n- âœ… EmpatÃ­a antes que venta\n- âœ… DirecciÃ³n completa obligatoria\n- âœ… Confirmar ciudad para mÃ©todo de pago\n- âœ… Tratamiento de 2L es lo recomendado\n- âœ… **NO confirmar datos si estÃ¡n correctos - proceder directo al cierre**\n- âœ… **Agregar datos gradualmente mientras el cliente los proporciona**\n- âœ… **Enviar resumen completo al finalizar el pedido**"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2,"position":[-740,240],"id":"a67bf7ad-b6e4-4825-9fce-533d095cde8e","name":"Agente Camila"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=memoria_prostagen_{{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[-700,500],"id":"f929e33e-be67-434d-add8-9fae3148eef3","name":"Redis Chat Memory","credentials":{"redis":{"id":"2vXSngOgq7Lx560G","name":"Redis Memoria Agentes"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"1bfdf3bd-4020-4e50-aa4e-73cf4e00490d","leftValue":"={{ $json.output }}","rightValue":"[[ENVIAR_TESTIMONIOS]]","operator":{"type":"string","operation":"contains"}}],"combinator":"or"},"options":{}},"name":"Â¿Piden testimonios?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-420,240],"id":"38d958dd-ea82-4ae2-acdb-dffa8d7d1744"},{"parameters":{"jsCode":"const baseUrl = \"https://grupodksoluciones.com/videos/\";\nconst texto = $json.output || \"\";\nconst marcadoresDisponibles = [\n  \"ENVIAR_TESTIMONIOS\",\n];\n\nconst marcadoresDetectados = marcadoresDisponibles.filter(m =>\n  texto.includes(`[[${m}]]`)\n);\n\nif (marcadoresDetectados.length === 0) {\n  return [\n    {\n      json: {\n        resultado: \"NO_MARKERS_FOUND\",\n        original: texto\n      }\n    }\n  ];\n}\n\nreturn [\n  {\n    json: {\n      marcadores: marcadoresDetectados\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-100,-20],"id":"ae00512d-6015-4f33-900f-6ff5f241cad3","name":"Detectar marcadores"},{"parameters":{"jsCode":"const marcadores = $json.marcadores || [];\n\nconst driveUrls = {\n  ENVIAR_TESTIMONIOS: [\n    \"https://grupodksoluciones.com/videos/testimonio_1.mp4\",\n    \"https://grupodksoluciones.com/videos/testimonio_2.mp4\"\n  ],\n};\n\nconst resultados = [];\n\nfor (const marcador of marcadores) {\n  const tipo = marcador.includes(\"VIDEO\") ? \"video\" : \"image\";\n  const urls = driveUrls[marcador] || [];\n\n  for (const url of urls) {\n    resultados.push({\n      json: {\n        tipo,\n        media_url: url\n      }\n    });\n  }\n}\n\nif (resultados.length === 0) {\n  return [{ json: { error: \"NO_FILES_FOUND\" } }];\n}\n\nreturn resultados;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[200,-300],"id":"d261d978-d711-410a-babe-efa776fc5703","name":"Generar lista multimedia"},{"parameters":{"method":"POST","url":"https://api-ws.wasapi.io/api/v1/whatsapp-messages/attachment","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"file","value":"video_url"},{"name":"from_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.from_id }}"},{"name":"wa_id","value":"={{ $('Webhook -- Wasapi').item.json.body.data.wa_id }}"},{"name":"video_url","value":"={{ $json.media_url }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[660,-580],"id":"d94db9c8-9f00-4949-987b-39469a9952fc","name":"Enviar videos testimonios"},{"parameters":{"jsCode":"// Tomar el mensaje del Agente Luisa\nconst mensajeDelAgente = $node[\"Agente Camila\"].json.output || \"\";\n\n// Eliminar marcadores del tipo [[...]]\nconst mensajeLimpio = mensajeDelAgente.replace(/\\[\\[.*?\\]\\]/g, '').replace(/\\s{2,}/g, ' ').trim();\n\n// Tomar datos del Webhook\nconst wa_id = $('Webhook -- Wasapi').first().json.body.data.wa_id;\nconst from_id = $('Webhook -- Wasapi').first().json.body.data.from_id;\n\nreturn [\n  {\n    json: {\n      mensaje_final: mensajeLimpio,\n      wa_id,\n      from_id\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,-300],"id":"80bb4d2e-6614-46d8-ae79-1c9279c8750a","name":"Limpiar Mensaje"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[840,-300],"id":"82dccf50-2f00-49cc-868a-70633c97b1eb","name":"Esperar Enviar Mensaje","webhookId":"aea33701-d126-44aa-bd69-d36c2a3e683e"},{"parameters":{"method":"POST","url":" https://api-ws.wasapi.io/api/v1/whatsapp-messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"Authorization","value":"Bearer 57853|vGRYO7hPg5s6QAWfwYKZFzE9qEJPSrT3bpzGps4L"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"message","value":"={{ $('Limpiar Mensaje').item.json.mensaje_final }}"},{"name":"wa_id","value":"={{ $('Limpiar Mensaje').item.json.wa_id }}"},{"name":"from_id","value":"={{ $('Limpiar Mensaje').item.json.from_id }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1060,-300],"id":"fba29d11-7c01-400d-b4ce-a0e8824bc20d","name":"Envia Mensaje"}],"connections":{"Webhook -- Wasapi":{"main":[[{"node":"Comprueba Estado de la ConversaciÃ³n","type":"main","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Recibe Mensaje","type":"main","index":0}]]},"Tipo de Mensaje":{"main":[[{"node":"Captura Audio","type":"main","index":0}],[{"node":"Recibe Mensaje","type":"main","index":0}]]},"Mapea el Mensaje Usuario":{"main":[[{"node":"Tipo de Mensaje","type":"main","index":0}]]},"Recibe Mensaje":{"main":[[{"node":"Timer para enviar mensaje","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Agente Camila","type":"ai_languageModel","index":0}]]},"Tipo de Respuesta":{"main":[[{"node":"Selecciona Respuesta","type":"main","index":0}]]},"Selecciona Respuesta":{"main":[[{"node":"Envia Mensaje Texto","type":"main","index":0}],[{"node":"Genera el audio","type":"main","index":0}]]},"Captura Audio":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"Descargar Audio":{"main":[[{"node":"Renombra Archivo Audio","type":"main","index":0}]]},"Envia Mensaje Texto":{"main":[[{"node":"Verifica si estan los Datos","type":"main","index":0}]]},"Verifica si estan los Datos":{"main":[[{"node":"Extrae los Datos del Pedido","type":"main","index":0}]]},"Extrae los Datos del Pedido":{"main":[[{"node":"Agrega Pedido Nuevo Hoja de Excel","type":"main","index":0}]]},"Agrega Pedido Nuevo Hoja de Excel":{"main":[[{"node":"Cambia Estado Conversacion","type":"main","index":0}]]},"Resultado de la Busquedad":{"main":[[{"node":"Verifica si el Contacto Existe","type":"main","index":0}]]},"Verifica si el Contacto Existe":{"main":[[{"node":"Datos Contacto","type":"main","index":0}],[]]},"Cambia Estado Conversacion":{"main":[[{"node":"Busca el Contacto","type":"main","index":0}]]},"Genera el audio":{"main":[[{"node":"Descargar Audio","type":"main","index":0}]]},"Renombra Archivo Audio":{"main":[[{"node":"Envia Mensajes Audio","type":"main","index":0}]]},"Timer para enviar mensaje":{"main":[[{"node":"Agente Camila","type":"main","index":0}]]},"Busca el Contacto":{"main":[[{"node":"Resultado de la Busquedad","type":"main","index":0}]]},"Datos Contacto":{"main":[[{"node":"Crear un Contacto","type":"main","index":0}]]},"Crear un Contacto":{"main":[[]]},"Comprueba Estado de la ConversaciÃ³n":{"main":[[{"node":"Mapea el Mensaje Usuario","type":"main","index":0}]]},"Agente Camila":{"main":[[{"node":"Â¿Piden testimonios?","type":"main","index":0}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"Agente Camila","type":"ai_memory","index":0}]]},"Envia Mensajes Audio":{"main":[[]]},"Â¿Piden testimonios?":{"main":[[{"node":"Detectar marcadores","type":"main","index":0}],[{"node":"Tipo de Respuesta","type":"main","index":0}]]},"Detectar marcadores":{"main":[[{"node":"Generar lista multimedia","type":"main","index":0}]]},"Generar lista multimedia":{"main":[[{"node":"Enviar videos testimonios","type":"main","index":0},{"node":"Limpiar Mensaje","type":"main","index":0}]]},"Enviar videos testimonios":{"main":[[]]},"Limpiar Mensaje":{"main":[[{"node":"Esperar Enviar Mensaje","type":"main","index":0}]]},"Esperar Enviar Mensaje":{"main":[[{"node":"Envia Mensaje","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook -- Wasapi":[{"json":{"headers":{"connection":"Upgrade","host":"n8.enterprisetecno.com","x-real-ip":"184.72.213.180","x-forwarded-for":"184.72.213.180","x-forwarded-proto":"https","content-length":"515","user-agent":"GuzzleHttp/7","content-type":"application/json"},"params":{},"query":{},"body":{"event":"receive_message","data":{"user_id":35641,"from_id":13571,"message":"Quiero ver testimonios","type":"in","message_type":"text","wa_id":"573105901444","wam_id":"wamid.HBgMNTczMTA1OTAxNDQ0FQIAEhgUM0YwMEYwQTQ1RkMzN0FEQzkwQTEA","context_wam_id":null,"status":"sent","caption":null,"filename":null,"origin":"webhook","data":"","created_at":"2025-07-26T03:52:16.000000Z","updated_at":"2025-07-26T03:52:16.000000Z","id":220121097,"chat_status":{"conversation_status":"hold","conversation_expiration":1753501917}}},"webhookUrl":"https://n8.enterprisetecno.com/webhook-test/cf693b5c-706a-4001-b5d8-6b64bc47e135","executionMode":"test"}}]},"versionId":"32344a3e-9373-4923-b2a4-430a38072270","triggerCount":1,"shared":[{"createdAt":"2025-07-16T20:04:26.666Z","updatedAt":"2025-07-16T20:04:26.666Z","role":"workflow:owner","workflowId":"RE0VSZTiXykM8Zbn","projectId":"B3H8EZwaIhSfaZKt"}],"tags":[]}